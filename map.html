<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BookMap â€” ë„ì„œ ê´€ê³„ë„</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <header class="bg-blue-600 text-white shadow">
    <div class="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
      <h1 class="text-xl font-bold">ğŸ“š BookMap</h1>
      <nav class="flex gap-6">
        <a href="index.html" class="hover:underline">í™ˆ</a>
        <a href="register.html" class="hover:underline">ë„ì„œ ë“±ë¡</a>
        <a href="book.html" class="hover:underline">ë¶ë§µ ë¦¬ìŠ¤íŠ¸</a>
        <a href="map.html" class="font-bold underline">ë¶ë§µ ë³´ê¸°</a>
      </nav>
    </div>
  </header>

  <!-- ì»¨í…Œì´ë„ˆ -->
  <main class="max-w-6xl mx-auto px-6 py-10">
    <h2 class="text-2xl font-bold mb-4">ğŸ“– ë„ì„œ ê´€ê³„ë„</h2>
    <p class="text-gray-700 mb-6">
      ë¶ë§µ ê´€ê³„ë„ëŠ” ë„ì„œ, ì €ì, ì£¼ì œ, ë‹¨ê³„ ë“±ê³¼ ê°™ì€ ê´€ê³„ì— ë”°ë¼ ì—°ê²°ë˜ëŠ” ê²ƒì„ ë³´ì—¬ì¤ë‹ˆë‹¤. 
      ë„ì„œëª…ì´ë‚˜ ì €ì ì´ë¦„ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ê°„ë‹¨í•œ ì„¤ëª…ì„ ë³¼ ìˆ˜ ìˆìœ¼ë©°, 
      <span class="font-semibold">í´ë¦­í•˜ì‹œë©´ í•´ë‹¹ ë„ì„œ ìƒì„¸í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.</span>
    </p>

    <!-- í•„í„° -->
    <section id="filters" class="bg-white p-4 rounded shadow mb-6">
      <h3 class="text-lg font-semibold mb-3">í•„í„°</h3>
      <div class="flex flex-wrap gap-6">
        <div>
          <p class="font-medium mb-2">ì¹´í…Œê³ ë¦¬</p>
          <div id="filter-category" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <p class="font-medium mb-2">ë‹¨ê³„</p>
          <div id="filter-level" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <p class="font-medium mb-2">ë„ì„œêµ¬ë¶„</p>
          <div id="filter-division" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <p class="font-medium mb-2">ì €ì</p>
          <div id="filter-author" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <p class="font-medium mb-2">ì£¼ì œ</p>
          <div id="filter-subject" class="flex flex-wrap gap-2"></div>
        </div>
      </div>
    </section>

    <!-- ë…¸ë“œ ìƒ‰ìƒ ì•ˆë‚´ -->
    <section class="bg-gray-100 p-3 rounded mb-6 text-sm text-gray-700">
      <div class="flex flex-wrap gap-6 items-center">
        <span class="flex items-center gap-1">
          <span class="w-3 h-3 rounded-full inline-block" style="background:black;"></span> í° ì£¼ì œ (ê²€ì€ìƒ‰)
        </span>
        <span class="flex items-center gap-1">
          <span class="w-3 h-3 rounded-full inline-block" style="background:purple;"></span> ì„¸ë¶€ ì£¼ì œ (ë³´ë¼ìƒ‰)
        </span>
        <span class="flex items-center gap-1">
          <span class="w-3 h-3 rounded-full inline-block" style="background:blue;"></span> ì €ì (íŒŒë€ìƒ‰)
        </span>
        <span class="flex items-center gap-1">
          <span class="w-3 h-3 rounded-full inline-block" style="background:orange;"></span> ì¹´í…Œê³ ë¦¬ (ì£¼í™©ìƒ‰)
        </span>
        <span class="flex items-center gap-1">
          <span class="w-3 h-3 rounded-full inline-block" style="background:green;"></span> ë„ì„œêµ¬ë¶„ (ì´ˆë¡ìƒ‰)
        </span>
        <span class="flex items-center gap-1">
          <span class="w-3 h-3 rounded-full inline-block" style="background:gray;"></span> ë„ì„œ (íšŒìƒ‰)
        </span>
      </div>
    </section>

    <!-- ë¡œë”© ë©”ì‹œì§€ -->
    <div id="loading" class="text-center text-gray-600 my-6">â³ ë¶ë§µ ê´€ê³„ë„ë¥¼ ë¡œë”©ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”. ê°ì‚¬í•©ë‹ˆë‹¤.</div>

    <!-- ê·¸ë˜í”„ -->
    <section class="bg-white p-4 rounded shadow">
      <svg id="graph" width="100%" height="600"></svg>
    </section>
  </main>

  <script>
    const colorScale = {
      theme: "black",
      subject: "purple",
      author: "blue",
      category: "orange",
      division: "green",
      book: "gray"
    };

    // âœ… í•„í„° ë²„íŠ¼ ìƒì„± í•¨ìˆ˜
    function createFilterButtons(containerId, items) {
      const container = document.getElementById(containerId);
      items.forEach(item => {
        const btn = document.createElement("button");
        btn.textContent = item;
        btn.className =
          "px-3 py-1 border rounded-full text-sm cursor-pointer transition " +
          "bg-gray-100 hover:bg-blue-100";
        btn.addEventListener("click", () => {
          btn.classList.toggle("bg-blue-500");
          btn.classList.toggle("text-white");
          btn.classList.toggle("border-blue-500");
          applyFilters();
        });
        container.appendChild(btn);
      });
    }

    // âœ… ë°ì´í„° ë¡œë“œ
    fetch("books.json")
      .then(res => res.json())
      .then(data => {
        document.getElementById("loading").style.display = "none";
        initGraph(data);
        initFilters(data);
      })
      .catch(err => {
        console.error("ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", err);
        document.getElementById("loading").textContent =
          "âŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      });

    function initFilters(data) {
      const categories = new Set();
      const levels = new Set();
      const divisions = new Set();
      const authors = new Set();
      const subjects = new Set();

      data.forEach(b => {
        b.category?.split(",").map(c => categories.add(c.trim()));
        if (b.level) levels.add(b.level.trim());
        if (b.division) divisions.add(b.division.trim());
        if (b.author) authors.add(b.author.trim());
        if (b.subject) subjects.add(b.subject.trim());
      });

      createFilterButtons("filter-category", [...categories]);
      createFilterButtons("filter-level", [...levels]);
      createFilterButtons("filter-division", [...divisions]);
      createFilterButtons("filter-author", [...authors]);
      createFilterButtons("filter-subject", [...subjects]);
    }

    // âœ… í•„í„° ì ìš©
    function applyFilters() {
      console.log("í•„í„°ë§ ë™ì‘ (ê·¸ë˜í”„ ì—…ë°ì´íŠ¸ í•„ìš”)");
      // ì—¬ê¸°ì„œ ì„ íƒëœ í•„í„° ê°’ì— ë§ê²Œ ê·¸ë˜í”„ë¥¼ ë‹¤ì‹œ ê·¸ë¦¬ëŠ” ë¡œì§ ì¶”ê°€ ì˜ˆì •
    }

    // âœ… D3.js ê·¸ë˜í”„
    function initGraph(data) {
      const svg = d3.select("#graph");
      const width = +svg.attr("width").replace("%", "") || 800;
      const height = +svg.attr("height") || 600;

      const nodes = [];
      const links = [];

      data.forEach(b => {
        nodes.push({ id: b.title, type: "book", info: b });
        if (b.author)
          nodes.push({ id: b.author, type: "author" });
        if (b.category)
          b.category.split(",").forEach(c =>
            nodes.push({ id: c.trim(), type: "category" })
          );
        if (b.division)
          nodes.push({ id: b.division, type: "division" });
        if (b.level)
          nodes.push({ id: b.level, type: "subject" });
      });

      const uniqueNodes = Array.from(new Map(nodes.map(n => [n.id, n])).values());

      data.forEach(b => {
        if (b.author) links.push({ source: b.title, target: b.author });
        if (b.category)
          b.category.split(",").forEach(c =>
            links.push({ source: b.title, target: c.trim() })
          );
        if (b.division) links.push({ source: b.title, target: b.division });
        if (b.level) links.push({ source: b.title, target: b.level });
      });

      const simulation = d3
        .forceSimulation(uniqueNodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(120))
        .force("charge", d3.forceManyBody().strength(-300))
        .force("center", d3.forceCenter(width / 2, height / 2));

      const link = svg
        .append("g")
        .attr("stroke", "#ccc")
        .selectAll("line")
        .data(links)
        .join("line")
        .attr("stroke-width", 1.5);

      const node = svg
        .append("g")
        .attr("stroke", "#fff")
        .attr("stroke-width", 1.5)
        .selectAll("circle")
        .data(uniqueNodes)
        .join("circle")
        .attr("r", 10)
        .attr("fill", d => colorScale[d.type] || "gray")
        .call(drag(simulation));

      node.append("title").text(d => d.id);

      simulation.on("tick", () => {
        link
          .attr("x1", d => d.source.x)
          .attr("y1", d => d.source.y)
          .attr("x2", d => d.target.x)
          .attr("y2", d => d.target.y);

        node.attr("cx", d => d.x).attr("cy", d => d.y);
      });

      function drag(simulation) {
        function dragstarted(event, d) {
          if (!event.active) simulation.alphaTarget(0.3).restart();
          d.fx = d.x;
          d.fy = d.y;
        }

        function dragged(event, d) {
          d.fx = event.x;
          d.fy = event.y;
        }

        function dragended(event, d) {
          if (!event.active) simulation.alphaTarget(0);
          d.fx = null;
          d.fy = null;
        }

        return d3.drag()
          .on("start", dragstarted)
          .on("drag", dragged)
          .on("end", dragended);
      }
    }
  </script>
</body>
</html>
