<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BookMap â€” ë¶ë§µ ë³´ê¸°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <style>
    #network {
      width: 100%;
      height: 80vh; /* í™”ë©´ ì „ì²´ ì°¨ì§€ */
      border: 1px solid #ddd;
      border-radius: 8px;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <header class="bg-blue-600 text-white shadow">
    <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
      <h1 class="text-xl font-bold">ğŸ“š BookMap</h1>
      <nav class="flex gap-6 text-sm">
        <a href="index.html" class="hover:underline">í™ˆ</a>
        <a href="form.html" class="hover:underline">ë„ì„œ ë“±ë¡</a>
        <a href="book.html" class="hover:underline">ë¶ë§µ ë¦¬ìŠ¤íŠ¸</a>
        <a href="map.html" class="hover:underline">ë¶ë§µ ë³´ê¸°</a>
      </nav>
    </div>
  </header>

  <!-- ë©”ì¸ -->
  <main class="max-w-7xl mx-auto px-6 py-8">
    <h2 class="text-2xl font-bold mb-6">ë¶ë§µ ê´€ê³„ë„</h2>

    <!-- í•„í„° -->
    <section class="bg-white p-6 rounded-xl shadow mb-6">
      <h3 class="font-semibold mb-4">í•„í„°</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div>
          <h4 class="text-sm font-medium mb-2">ì¹´í…Œê³ ë¦¬</h4>
          <div id="categoryFilter" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <h4 class="text-sm font-medium mb-2">ë‹¨ê³„</h4>
          <div id="levelFilter" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <h4 class="text-sm font-medium mb-2">ë„ì„œêµ¬ë¶„</h4>
          <div id="divisionFilter" class="flex flex-wrap gap-2"></div>
        </div>
      </div>
    </section>

    <!-- ë„¤íŠ¸ì›Œí¬ ê·¸ë˜í”„ -->
    <div id="network"></div>

    <!-- ë²”ë¡€ -->
    <div class="mt-6 bg-white p-4 rounded-xl shadow text-sm text-gray-700">
      <h4 class="font-semibold mb-2">ë…¸ë“œ ìƒ‰ìƒ ì•ˆë‚´</h4>
      <ul class="space-y-1">
        <li><span class="inline-block w-4 h-4 rounded-full bg-black mr-2"></span>ì£¼ì œ</li>
        <li><span class="inline-block w-4 h-4 rounded-full bg-blue-500 mr-2"></span>ì €ì</li>
        <li><span class="inline-block w-4 h-4 rounded-full bg-purple-500 mr-2"></span>ì¹´í…Œê³ ë¦¬</li>
        <li><span class="inline-block w-4 h-4 rounded-full bg-green-500 mr-2"></span>ë„ì„œêµ¬ë¶„ (êµ­ë‚´/ì›ì„œ/ë²ˆì—­)</li>
        <li><span class="inline-block w-4 h-4 rounded-full bg-gray-200 border mr-2"></span>ë„ì„œ (ì±… ì œëª©)</li>
      </ul>
    </div>
  </main>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbywJOW4dOlmDrzood3ka_jizri4K7sFqTJDPG8ibnmDrxXZgFWrFnjMEv38C5pCtjp_/exec";

    let allBooks = [];
    let selectedCategories = new Set();
    let selectedLevels = new Set();
    let selectedDivisions = new Set();
    let network;

    async function loadBooks() {
      const res = await fetch(API_URL);
      allBooks = await res.json();
      renderFilters();
      renderNetwork();
    }

    function renderFilters() {
      const categories = new Set();
      const levels = new Set();
      const divisions = new Set();

      allBooks.forEach(book => {
        if (book.category) {
          book.category.split(",").map(c => c.trim()).forEach(c => categories.add(c));
        }
        if (book.level) levels.add(book.level);
        if (book.division) divisions.add(book.division);
      });

      document.getElementById("categoryFilter").innerHTML = Array.from(categories).map(cat => `
        <button onclick="toggleFilter('category','${cat}')"
          class="px-3 py-1 border rounded-full text-sm hover:bg-blue-100">${cat}</button>
      `).join("");

      document.getElementById("levelFilter").innerHTML = Array.from(levels).map(level => `
        <button onclick="toggleFilter('level','${level}')"
          class="px-3 py-1 border rounded-full text-sm hover:bg-blue-100">${level}</button>
      `).join("");

      document.getElementById("divisionFilter").innerHTML = Array.from(divisions).map(div => `
        <button onclick="toggleFilter('division','${div}')"
          class="px-3 py-1 border rounded-full text-sm hover:bg-blue-100">${div}</button>
      `).join("");
    }

    function toggleFilter(type, value) {
      let set = type === "category" ? selectedCategories :
                type === "level" ? selectedLevels : selectedDivisions;
      if (set.has(value)) set.delete(value);
      else set.add(value);
      renderNetwork();
    }

    function renderNetwork() {
      const nodes = [];
      const edges = [];

      const filtered = allBooks.filter(book => {
        const cats = book.category ? book.category.split(",").map(c => c.trim()) : [];
        const categoryMatch = selectedCategories.size === 0 || cats.some(c => selectedCategories.has(c));
        const levelMatch = selectedLevels.size === 0 || selectedLevels.has(book.level);
        const divisionMatch = selectedDivisions.size === 0 || selectedDivisions.has(book.division);
        return categoryMatch && levelMatch && divisionMatch;
      });

      const addedNodes = new Set();

      filtered.forEach(book => {
        // ì£¼ì œ ë…¸ë“œ (ê²€ì€ìƒ‰)
        if (book.subject && !addedNodes.has("subject-" + book.subject)) {
          nodes.push({ id: "subject-" + book.subject, label: book.subject, color: "black", font: { color: "white" } });
          addedNodes.add("subject-" + book.subject);
        }

        // ì €ì ë…¸ë“œ (íŒŒë€ìƒ‰)
        if (book.author && !addedNodes.has("author-" + book.author)) {
          nodes.push({ id: "author-" + book.author, label: book.author, color: "#3B82F6", font: { color: "white" } });
          addedNodes.add("author-" + book.author);
        }

        // ì¹´í…Œê³ ë¦¬ ë…¸ë“œ (ë³´ë¼ìƒ‰)
        const cats = book.category ? book.category.split(",").map(c => c.trim()) : [];
        cats.forEach(c => {
          if (!addedNodes.has("cat-" + c)) {
            nodes.push({ id: "cat-" + c, label: c, color: "#8B5CF6", font: { color: "white" } });
            addedNodes.add("cat-" + c);
          }
        });

        // ë„ì„œêµ¬ë¶„ ë…¸ë“œ (ì´ˆë¡ìƒ‰) â€” êµ­ë‚´/ì›ì„œ/ë²ˆì—­
        if (book.division && !addedNodes.has("div-" + book.division)) {
          nodes.push({ id: "div-" + book.division, label: book.division, color: "#10B981", font: { color: "white" } });
          addedNodes.add("div-" + book.division);
        }

        // ë„ì„œ ë…¸ë“œ (ì±… ì œëª©)
        nodes.push({ id: "book-" + book.id, label: book.title, shape: "box", color: "#E5E7EB" });

        // ê´€ê³„ ì—°ê²°
        if (book.subject) edges.push({ from: "subject-" + book.subject, to: "book-" + book.id });
        if (book.author) edges.push({ from: "author-" + book.author, to: "book-" + book.id });
        cats.forEach(c => edges.push({ from: "cat-" + c, to: "book-" + book.id }));
        if (book.division) edges.push({ from: "div-" + book.division, to: "book-" + book.id });
      });

      const container = document.getElementById("network");
      const data = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
      const options = {
        physics: { stabilization: false },
        interaction: { dragNodes: true, dragView: true, zoomView: true }
      };

      if (network) network.destroy();
      network = new vis.Network(container, data, options);

      // ë„ì„œ í´ë¦­ ì‹œ ìƒì„¸ í˜ì´ì§€ ì´ë™
      network.on("click", params => {
        if (params.nodes.length > 0 && params.nodes[0].startsWith("book-")) {
          const bookId = params.nodes[0].replace("book-", "");
          window.location.href = `book-detail.html?id=${bookId}`;
        }
      });
    }

    loadBooks();
  </script>
</body>
</html>
