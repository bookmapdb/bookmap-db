<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BookMap — 관계도</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { margin: 0; background: #f9fafb; }
    .node text { font-size: 12px; fill: #333; }
    .link { stroke: #999; stroke-opacity: 0.6; }
  </style>
</head>
<body class="text-gray-800">

  <!-- 상단 네비게이션 -->
  <header class="bg-blue-600 text-white shadow fixed top-0 left-0 w-full z-10">
    <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
      <h1 class="text-xl font-bold">📚 BookMap</h1>
      <nav class="flex gap-6 text-sm">
        <a href="index.html" class="hover:underline">홈</a>
        <a href="form.html" class="hover:underline">도서 등록</a>
        <a href="book.html" class="hover:underline">북맵 리스트</a>
        <a href="map.html" class="hover:underline">북맵 보기</a>
      </nav>
    </div>
  </header>

  <!-- 메인 (SVG 전체 화면) -->
  <main class="w-full h-screen pt-20">
    <svg id="graph" width="100%" height="100%"></svg>

    <!-- 안내 문구 -->
    <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-white shadow px-4 py-2 rounded-lg text-sm flex gap-4">
      <span>🔵 도서</span>
      <span>⚫ 주제</span>
      <span>🟢 저자</span>
      <span>🟣 카테고리</span>
      <span>🟠 단계</span>
      <span>🔴 도서구분</span>
    </div>
  </main>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbywJOW4dOlmDrzood3ka_jizri4K7sFqTJDPG8ibnmDrxXZgFWrFnjMEv38C5pCtjp_/exec";

    async function loadData() {
      const res = await fetch(API_URL);
      const books = await res.json();
      renderGraph(books);
    }

    function renderGraph(books) {
      const nodes = [];
      const links = [];

      const nodeById = new Map();

      // 노드 추가 함수
      function addNode(id, label, type) {
        if (!nodeById.has(id)) {
          const node = { id, label, type };
          nodeById.set(id, node);
          nodes.push(node);
        }
        return nodeById.get(id);
      }

      books.forEach(book => {
        // 주제 노드 (검은색)
        const themeNode = addNode("theme-" + book.theme, book.theme || "미정", "theme");

        // 도서 노드 (파랑)
        const bookNode = addNode("book-" + book.id, book.title, "book");
        links.push({ source: themeNode.id, target: bookNode.id });

        // 저자 노드 (초록)
        if (book.author) {
          const authorNode = addNode("author-" + book.author, book.author, "author");
          links.push({ source: bookNode.id, target: authorNode.id });
        }

        // 카테고리 노드 (보라)
        if (book.category) {
          const categories = book.category.split(",").map(c => c.trim());
          categories.forEach(cat => {
            const catNode = addNode("cat-" + cat, cat, "category");
            links.push({ source: bookNode.id, target: catNode.id });
          });
        }

        // 단계 노드 (주황)
        if (book.level) {
          const levelNode = addNode("level-" + book.level, book.level, "level");
          links.push({ source: bookNode.id, target: levelNode.id });
        }

        // 도서구분 노드 (빨강, 짧게 표기)
        if (book.division) {
          const divLabel = book.division.replace("도서", ""); // "국내서" 그대로, "원서", "번역서"도 짧게
          const divisionNode = addNode("division-" + divLabel, divLabel, "division");
          links.push({ source: bookNode.id, target: divisionNode.id });
        }
      });

      const svg = d3.select("#graph");
      const width = window.innerWidth;
      const height = window.innerHeight;

      // 줌/드래그 활성화
      const zoom = d3.zoom().on("zoom", (event) => {
        g.attr("transform", event.transform);
      });
      svg.call(zoom);

      const g = svg.append("g");

      const link = g.append("g")
        .attr("stroke", "#aaa")
        .selectAll("line")
        .data(links)
        .enter().append("line")
        .attr("class", "link");

      const node = g.append("g")
        .selectAll("circle")
        .data(nodes)
        .enter().append("circle")
        .attr("r", 14)
        .attr("fill", d => {
          if (d.type === "book") return "#2563eb"; // 파랑
          if (d.type === "theme") return "#111111"; // 검정
          if (d.type === "author") return "#16a34a"; // 초록
          if (d.type === "category") return "#9333ea"; // 보라
          if (d.type === "level") return "#f97316"; // 주황
          if (d.type === "division") return "#dc2626"; // 빨강
          return "#999";
        })
        .call(drag(simulation));

      const label = g.append("g")
        .selectAll("text")
        .data(nodes)
        .enter().append("text")
        .text(d => d.label)
        .attr("x", 18)
        .attr("y", 4);

      const simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(100))
        .force("charge", d3.forceManyBody().strength(-400))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .on("tick", ticked);

      function ticked() {
        link
          .attr("x1", d => d.source.x)
          .attr("y1", d => d.source.y)
          .attr("x2", d => d.target.x)
          .attr("y2", d => d.target.y);

        node
          .attr("cx", d => d.x)
          .attr("cy", d => d.y);

        label
          .attr("x", d => d.x + 18)
          .attr("y", d => d.y + 4);
      }

      function drag(simulation) {
        return d3.drag()
          .on("start", (event, d) => {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
          })
          .on("drag", (event, d) => {
            d.fx = event.x;
            d.fy = event.y;
          })
          .on("end", (event, d) => {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
          });
      }
    }

    loadData();
  </script>
</body>
</html>
