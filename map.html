<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BookMap ‚Äî Í¥ÄÍ≥ÑÎèÑ Î≥¥Í∏∞</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/cytoscape@3.28.0/dist/cytoscape.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- ÏÉÅÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
  <header class="bg-blue-600 text-white shadow">
    <div class="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
      <h1 class="text-xl font-bold">üìö BookMap ‚Äî Í¥ÄÍ≥ÑÎèÑ</h1>
      <nav class="flex gap-6 text-sm items-center">
        <a href="index.html" class="hover:underline">Ìôà</a>
        <a href="form.html" class="hover:underline">ÎèÑÏÑú Îì±Î°ù</a>
        <a href="book.html" class="hover:underline">Î∂ÅÎßµ Î¶¨Ïä§Ìä∏</a>

        <!-- Í≤ÄÏÉâÏ∞Ω -->
        <form id="searchForm" class="ml-4 flex">
          <input type="text" id="searchInput" placeholder="Ï±Ö Ï†úÎ™© ÎòêÎäî Ï†ÄÏûê Í≤ÄÏÉâ"
            class="px-2 py-1 rounded-l border border-gray-300 text-black w-40 md:w-60">
          <button type="submit" class="px-3 py-1 bg-white text-blue-600 font-semibold rounded-r border border-gray-300 hover:bg-gray-100">
            Í≤ÄÏÉâ
          </button>
        </form>
      </nav>
    </div>
  </header>

  <!-- Î©îÏù∏ -->
  <main class="max-w-6xl mx-auto px-6 py-8">
    <div id="bookMap" class="w-full h-[600px] border rounded bg-white"></div>
  </main>

  <script>
  // üîé Í≤ÄÏÉâ Í∏∞Îä•
  document.getElementById("searchForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const query = document.getElementById("searchInput").value.trim();
    if (!query) return;

    const res = await fetch("books.json");
    const books = await res.json();

    // Ï±Ö Ï†úÎ™© Î®ºÏ†Ä Í≤ÄÏÉâ
    const bookMatch = books.find(b => b.title.trim().toLowerCase() === query.toLowerCase());
    if (bookMatch) {
      window.location.href = `map.html?title=${encodeURIComponent(query)}`;
      return;
    }

    // ÏóÜÏúºÎ©¥ Ï†ÄÏûê Í≤ÄÏÉâ
    const authorMatch = books.find(b => b.author.trim().toLowerCase() === query.toLowerCase());
    if (authorMatch) {
      window.location.href = `map.html?author=${encodeURIComponent(query)}`;
      return;
    }

    alert("Ìï¥Îãπ Ï±Ö Ï†úÎ™©Ïù¥ÎÇò Ï†ÄÏûêÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
  });

  async function loadBookMap() {
    const urlParams = new URLSearchParams(window.location.search);
    const bookId = urlParams.get("id");
    const bookTitle = urlParams.get("title");
    const categoryParam = urlParams.get("category");
    const authorParam = urlParams.get("author");

    const res = await fetch("books.json");
    const books = await res.json();

    let book = null;
    let mode = "book";

    if (bookId) {
      book = books.find(b => String(b.id) === String(bookId));
    } else if (bookTitle) {
      const titleQuery = bookTitle.trim().toLowerCase();
      book = books.find(b => b.title.trim().toLowerCase() === titleQuery);
    } else if (categoryParam) {
      mode = "category";
    } else if (authorParam) {
      mode = "author";
    }

    if (mode === "book" && !book) {
      document.getElementById("bookMap").innerHTML =
        `<p class="text-center text-gray-500 py-20">Ìï¥Îãπ ÎèÑÏÑúÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.</p>`;
      return;
    }

    let nodes = [];
    let edges = [];

    if (mode === "book") {
      const bookIdStr = String(book.id);
      nodes.push({ data: { id: bookIdStr, label: book.title, type: "book" } });

      nodes.push({ data: { id: "level-" + book.level, label: book.level, type: "level" } });
      edges.push({ data: { source: bookIdStr, target: "level-" + book.level } });

      let categories = [];
      if (Array.isArray(book.category)) categories = book.category;
      else if (typeof book.category === "string") categories = book.category.split(",").map(c => c.trim());

      categories.forEach(cat => {
        nodes.push({ data: { id: "cat-" + cat, label: cat, type: "category" } });
        edges.push({ data: { source: bookIdStr, target: "cat-" + cat } });
      });

      if (book.author) {
        nodes.push({ data: { id: "author-" + book.author, label: book.author, type: "author" } });
        edges.push({ data: { source: bookIdStr, target: "author-" + book.author } });
      }

      books.forEach(b => {
        if (b.id !== book.id) {
          let otherCats = [];
          if (Array.isArray(b.category)) otherCats = b.category;
          else if (typeof b.category === "string") otherCats = b.category.split(",").map(c => c.trim());

          if (otherCats.some(cat => categories.includes(cat))) {
            nodes.push({ data: { id: String(b.id), label: b.title, type: "related" } });
            edges.push({ data: { source: "cat-" + otherCats[0], target: String(b.id) } });
          }

          if (b.level === book.level) {
            nodes.push({ data: { id: String(b.id), label: b.title, type: "related" } });
            edges.push({ data: { source: "level-" + b.level, target: String(b.id) } });
          }

          if (book.author && b.author === book.author) {
            nodes.push({ data: { id: String(b.id), label: b.title, type: "related" } });
            edges.push({ data: { source: "author-" + book.author, target: String(b.id) } });
          }
        }
      });

    } else if (mode === "category") {
      const cat = categoryParam.trim();
      nodes.push({ data: { id: "cat-" + cat, label: cat, type: "category" } });

      const grouped = {};
      books.forEach(b => {
        let cats = [];
        if (Array.isArray(b.category)) cats = b.category;
        else if (typeof b.category === "string") cats = b.category.split(",").map(c => c.trim());

        if (cats.includes(cat)) {
          if (!grouped[b.level]) grouped[b.level] = [];
          grouped[b.level].push(b);
        }
      });

      Object.keys(grouped).forEach(level => {
        nodes.push({ data: { id: "level-" + level, label: level, type: "level" } });
        edges.push({ data: { source: "cat-" + cat, target: "level-" + level } });

        grouped[level].forEach(b => {
          nodes.push({ data: { id: String(b.id), label: b.title, type: "related" } });
          edges.push({ data: { source: "level-" + level, target: String(b.id) } });

          if (b.author) {
            const authorId = "author-" + b.author;
            if (!nodes.find(n => n.data.id === authorId)) {
              nodes.push({ data: { id: authorId, label: b.author, type: "author" } });
            }
            edges.push({ data: { source: String(b.id), target: authorId } });
          }
        });
      });

    } else if (mode === "author") {
      const author = authorParam.trim();
      nodes.push({ data: { id: "author-" + author, label: author, type: "author" } });

      books.forEach(b => {
        if (b.author === author) {
          nodes.push({ data: { id: String(b.id), label: b.title, type: "related" } });
          edges.push({ data: { source: "author-" + author, target: String(b.id) } });

          let cats = [];
          if (Array.isArray(b.category)) cats = b.category;
          else if (typeof b.category === "string") cats = b.category.split(",").map(c => c.trim());
          cats.forEach(cat => {
            const catId = "cat-" + cat;
            if (!nodes.find(n => n.data.id === catId)) {
              nodes.push({ data: { id: catId, label: cat, type: "category" } });
            }
            edges.push({ data: { source: String(b.id), target: catId } });
          });

          if (b.level) {
            const levelId = "level-" + b.level;
            if (!nodes.find(n => n.data.id === levelId)) {
              nodes.push({ data: { id: levelId, label: b.level, type: "level" } });
            }
            edges.push({ data: { source: String(b.id), target: levelId } });
          }
        }
      });
    }

    const cy = cytoscape({
      container: document.getElementById("bookMap"),
      elements: { nodes, edges },
      style: [
        { selector: 'node[type="book"]', style: { 'background-color': '#3b82f6', 'label': 'data(label)', 'color': '#fff', 'font-size': 12 }},
        { selector: 'node[type="related"]', style: { 'background-color': '#9ca3af', 'label': 'data(label)', 'font-size': 11 }},
        { selector: 'node[type="category"]', style: { 'background-color': '#10b981', 'label': 'data(label)', 'shape': 'round-rectangle', 'color': '#fff', 'font-size': 11 }},
        { selector: 'node[type="level"]', style: { 'background-color': '#f59e0b', 'label': 'data(label)', 'shape': 'diamond', 'color': '#fff', 'font-size': 11 }},
        { selector: 'node[type="author"]', style: { 'background-color': '#8b5cf6', 'label': 'data(label)', 'shape': 'ellipse', 'color': '#fff', 'font-size': 11 }},
        { selector: 'edge', style: { 'width': 2, 'line-color': '#d1d5db', 'target-arrow-shape': 'triangle', 'target-arrow-color': '#d1d5db', 'curve-style': 'bezier' }}
      ],
      layout: { name: 'breadthfirst', directed: true, padding: 30, spacingFactor: 1.2, animate: true }
    });

    cy.on('tap', 'node', function(evt){
      const node = evt.target;
      const type = node.data('type');

      if (type === 'book' || type === 'related') {
        window.location.href = `book-detail.html?id=${node.id()}`;
      }
      if (type === 'author' && !authorParam) {
        const authorName = node.data('label');
        window.location.href = `map.html?author=${encodeURIComponent(authorName)}`;
      }
    });

    cy.on('tap', 'node', function(evt){
      const node = evt.target;
      const neighborhood = node.closedNeighborhood();
      cy.elements().addClass('faded');
      neighborhood.removeClass('faded');
      node.addClass('highlighted');
    });

    cy.on('tap', function(evt){
      if(evt.target === cy){
        cy.elements().removeClass('faded highlighted');
      }
    });

    cy.style()
      .selector('.faded').style({ 'opacity': 0.2 })
      .selector('.highlighted').style({ 'border-width': 3, 'border-color': '#000' })
      .update();
  }

  loadBookMap();
  </script>
</body>
</html>
