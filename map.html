<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BookMap β€” κ΄€κ³„λ„</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    .filter-btn.active {
      background-color: #2563eb; /* blue-600 */
      color: white;
      border-color: #2563eb;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- μƒλ‹¨ λ„¤λΉ„κ²μ΄μ… -->
  <header class="bg-blue-600 text-white shadow">
    <div class="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
      <h1 class="text-xl font-bold">π“ BookMap</h1>
      <nav class="flex gap-6 text-sm">
        <a href="index.html" class="hover:underline">ν™</a>
        <a href="form.html" class="hover:underline">λ„μ„ λ“±λ΅</a>
        <a href="book.html" class="hover:underline">λ¶λ§µ λ¦¬μ¤νΈ</a>
        <a href="map.html" class="hover:underline">λ¶λ§µ λ³΄κΈ°</a>
      </nav>
    </div>
  </header>

  <!-- μ•λ‚΄λ¬Έκµ¬ -->
  <main class="max-w-6xl mx-auto px-6 py-6">
    <p class="mb-4 text-gray-700 text-sm">
      λ¶λ§µ κ΄€κ³„λ„λ”, λ„μ„, μ €μ, μ£Όμ , λ‹¨κ³„ λ“±κ³Ό κ°™μ€ κ΄€κ³„μ— λ”°λΌ μ—°κ²°λλ” κ²ƒμ„ λ³΄μ—¬μ¤λ‹λ‹¤. 
      λ„μ„λ…μ΄λ‚ μ €μ μ΄λ¦„μ— λ§μ°μ¤λ¥Ό μ¬λ ¤λ†“μΌλ©΄ κ°„λ‹¨ν• μ„¤λ…μ„ λ³Ό μ μμΌλ©°, 
      ν΄λ¦­ν•μ‹λ©΄ ν•΄λ‹Ή λ„μ„ μƒμ„Ένμ΄μ§€λ΅ λ„μ–΄κ°‘λ‹λ‹¤.
    </p>

    <!-- ν•„ν„° μμ—­ -->
    <section class="bg-white p-4 rounded-xl shadow mb-4">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <h4 class="text-sm font-medium mb-2">μΉ΄ν…κ³ λ¦¬</h4>
          <div id="categoryFilter" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <h4 class="text-sm font-medium mb-2">λ‹¨κ³„</h4>
          <div id="levelFilter" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <h4 class="text-sm font-medium mb-2">λ„μ„κµ¬λ¶„</h4>
          <div id="divisionFilter" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <h4 class="text-sm font-medium mb-2">μ €μ</h4>
          <div id="authorFilter" class="flex flex-wrap gap-2"></div>
        </div>
      </div>
    </section>

    <!-- λ…Έλ“ μƒ‰μƒ μ•λ‚΄ -->
    <section class="bg-gray-100 p-3 rounded mb-6 text-sm text-gray-700">
      <div class="flex flex-wrap gap-4">
        <span>β¬¤ <span class="font-medium">ν° μ£Όμ </span> (κ²€μ€μƒ‰)</span>
        <span>β¬¤ <span class="font-medium">μ„Έλ¶€ μ£Όμ </span> (λ³΄λΌμƒ‰)</span>
        <span>β¬¤ <span class="font-medium">μ €μ</span> (νλ€μƒ‰)</span>
        <span>β¬¤ <span class="font-medium">μΉ΄ν…κ³ λ¦¬</span> (μ£Όν™©μƒ‰)</span>
        <span>β¬¤ <span class="font-medium">λ„μ„κµ¬λ¶„</span> (μ΄λ΅μƒ‰)</span>
        <span>β¬¤ <span class="font-medium">λ„μ„</span> (νμƒ‰)</span>
      </div>
    </section>

    <!-- λ΅λ”© λ©”μ‹μ§€ -->
    <div id="loading" class="text-center text-gray-500 mb-6">
      β³ λ¶λ§µ κ΄€κ³„λ„λ¥Ό λ΅λ”©μ¤‘μ…λ‹λ‹¤. μ μ‹λ§ κΈ°λ‹¤λ ¤μ£Όμ„Έμ”. κ°μ‚¬ν•©λ‹λ‹¤.
    </div>

    <!-- κ΄€κ³„λ„ μμ—­ -->
    <svg id="graph" width="100%" height="700"></svg>
  </main>

  <script>
    const API_URL = "books.json"; // JSON νμΌ λ΅λ“
    let allBooks = [];
    let selectedCategories = new Set();
    let selectedLevels = new Set();
    let selectedDivisions = new Set();
    let selectedAuthors = new Set();

    async function loadBooks() {
      const res = await fetch(API_URL);
      allBooks = await res.json();
      document.getElementById("loading").classList.add("hidden");
      renderFilters();
      renderGraph();
    }

    function renderFilters() {
      const categories = new Set();
      const levels = new Set();
      const divisions = new Set(["κµ­λ‚΄μ„","μ›μ„","λ²μ—­μ„"]);
      const authors = new Set();

      allBooks.forEach(book => {
        (book.category || "").split(",").map(c => c.trim()).forEach(c => categories.add(c));
        if (book.level) levels.add(book.level);
        if (book.division) divisions.add(book.division);
        if (book.author) authors.add(book.author);
      });

      const categoryFilter = document.getElementById("categoryFilter");
      categoryFilter.innerHTML = Array.from(categories).map(cat => `
        <button onclick="toggleFilter('category','${cat}', this)" 
          class="filter-btn px-3 py-1 rounded-full border border-gray-300 text-sm hover:bg-blue-100">${cat}</button>
      `).join("");

      const levelFilter = document.getElementById("levelFilter");
      levelFilter.innerHTML = Array.from(levels).map(level => `
        <button onclick="toggleFilter('level','${level}', this)" 
          class="filter-btn px-3 py-1 rounded-full border border-gray-300 text-sm hover:bg-blue-100">${level}</button>
      `).join("");

      const divisionFilter = document.getElementById("divisionFilter");
      divisionFilter.innerHTML = Array.from(divisions).map(div => `
        <button onclick="toggleFilter('division','${div}', this)" 
          class="filter-btn px-3 py-1 rounded-full border border-gray-300 text-sm hover:bg-blue-100">${div}</button>
      `).join("");

      const authorFilter = document.getElementById("authorFilter");
      authorFilter.innerHTML = Array.from(authors).map(author => `
        <button onclick="toggleFilter('author','${author}', this)" 
          class="filter-btn px-3 py-1 rounded-full border border-gray-300 text-sm hover:bg-blue-100">${author}</button>
      `).join("");
    }

    function toggleFilter(type, value, btn) {
      let set;
      if (type === "category") set = selectedCategories;
      if (type === "level") set = selectedLevels;
      if (type === "division") set = selectedDivisions;
      if (type === "author") set = selectedAuthors;

      if (set.has(value)) {
        set.delete(value);
        btn.classList.remove("active");
      } else {
        set.add(value);
        btn.classList.add("active");
      }
      renderGraph();
    }

    function renderGraph() {
      const svg = d3.select("#graph");
      svg.selectAll("*").remove();

      const nodes = [];
      const links = [];

      const filtered = allBooks.filter(book => {
        const cats = (book.category || "").split(",").map(c => c.trim());
        const categoryMatch = selectedCategories.size === 0 || cats.some(c => selectedCategories.has(c));
        const levelMatch = selectedLevels.size === 0 || selectedLevels.has(book.level);
        const divisionMatch = selectedDivisions.size === 0 || selectedDivisions.has(book.division);
        const authorMatch = selectedAuthors.size === 0 || selectedAuthors.has(book.author);
        return categoryMatch && levelMatch && divisionMatch && authorMatch;
      });

      filtered.forEach(book => {
        const bookNode = { id: book.title, type: "λ„μ„", info: book.description || "" };
        nodes.push(bookNode);

        if (book.author) {
          nodes.push({ id: book.author, type: "μ €μ" });
          links.push({ source: book.title, target: book.author });
        }
        if (book.category) {
          (book.category.split(",")).forEach(cat => {
            nodes.push({ id: cat.trim(), type: "μΉ΄ν…κ³ λ¦¬" });
            links.push({ source: book.title, target: cat.trim() });
          });
        }
        if (book.division) {
          nodes.push({ id: book.division, type: "λ„μ„κµ¬λ¶„" });
          links.push({ source: book.title, target: book.division });
        }
        if (book.level) {
          nodes.push({ id: book.level, type: "λ‹¨κ³„" });
          links.push({ source: book.title, target: book.level });
        }
      });

      const uniqueNodes = Array.from(new Map(nodes.map(n => [n.id, n])).values());

      const colorScale = {
        "ν°μ£Όμ ": "black",
        "μ„Έλ¶€μ£Όμ ": "purple",
        "μ €μ": "blue",
        "μΉ΄ν…κ³ λ¦¬": "orange",
        "λ„μ„κµ¬λ¶„": "green",
        "λ„μ„": "gray"
      };

      const simulation = d3.forceSimulation(uniqueNodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(120))
        .force("charge", d3.forceManyBody().strength(-500))
        .force("center", d3.forceCenter(svg.node().clientWidth / 2, svg.node().clientHeight / 2));

      const link = svg.append("g")
        .attr("stroke", "#aaa")
        .selectAll("line")
        .data(links)
        .enter().append("line");

      const node = svg.append("g")
        .selectAll("circle")
        .data(uniqueNodes)
        .enter().append("circle")
        .attr("r", 15)
        .attr("fill", d => colorScale[d.type] || "gray")
        .call(d3.drag()
          .on("start", dragstarted)
          .on("drag", dragged)
          .on("end", dragended))
        .on("mouseover", (e, d) => {
          const tooltip = document.createElement("div");
          tooltip.id = "tooltip";
          tooltip.className = "absolute bg-white text-xs px-2 py-1 border rounded shadow";
          tooltip.style.left = e.pageX + 5 + "px";
          tooltip.style.top = e.pageY + 5 + "px";
          tooltip.innerText = d.info || d.id;
          document.body.appendChild(tooltip);
        })
        .on("mouseout", () => {
          document.getElementById("tooltip")?.remove();
        })
        .on("click", (e, d) => {
          if (d.type === "λ„μ„") {
            const book = allBooks.find(b => b.title === d.id);
            if (book) window.location.href = `book-detail.html?id=${book.id}`;
          }
        });

      const label = svg.append("g")
        .selectAll("text")
        .data(uniqueNodes)
        .enter().append("text")
        .attr("font-size", 10)
        .attr("dy", -20)
        .text(d => d.id);

      simulation.on("tick", () => {
        link.attr("x1", d => d.source.x)
          .attr("y1", d => d.source.y)
          .attr("x2", d => d.target.x)
          .attr("y2", d => d.target.y);

        node.attr("cx", d => d.x).attr("cy", d => d.y);
        label.attr("x", d => d.x).attr("y", d => d.y);
      });

      function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x; d.fy = d.y;
      }
      function dragged(event, d) {
        d.fx = event.x; d.fy = event.y;
      }
      function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null; d.fy = null;
      }
    }

    loadBooks();
  </script>
</body>
</html>
