<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BookMap — 관계도</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- D3.js -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- 상단 네비게이션 -->
  <header class="bg-blue-600 text-white shadow">
    <div class="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
      <h1 class="text-xl font-bold">📚 BookMap</h1>
      <nav class="flex gap-6 text-sm">
        <a href="index.html" class="hover:underline">홈</a>
        <a href="form.html" class="hover:underline">도서 등록</a>
        <a href="book.html" class="hover:underline">북맵 리스트</a>
        <a href="map.html" class="hover:underline">관계도</a>
      </nav>
    </div>
  </header>

  <!-- 메인 -->
  <main class="max-w-6xl mx-auto px-6 py-10">
    <h2 class="text-2xl font-bold mb-6">📖 도서 관계도</h2>
    <div id="chart" class="bg-white p-6 rounded-xl shadow"></div>
  </main>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbywJOW4dOlmDrzood3ka_jizri4K7sFqTJDPG8ibnmDrxXZgFWrFnjMEv38C5pCtjp_/exec";

    async function loadData() {
      const res = await fetch(API_URL);
      const books = await res.json();
      drawTree(books);
    }

    function drawTree(books) {
      // 데이터 변환: 카테고리 → 단계 → 도서 구조
      const categoryMap = {};

      books.forEach(book => {
        let categories = [];
        if (Array.isArray(book.category)) {
          categories = book.category;
        } else if (typeof book.category === "string") {
          categories = book.category.split(",").map(c => c.trim());
        }

        categories.forEach(cat => {
          if (!categoryMap[cat]) categoryMap[cat] = {};
          if (!categoryMap[cat][book.level]) categoryMap[cat][book.level] = [];
          categoryMap[cat][book.level].push(book);
        });
      });

      const data = {
        name: "BookMap",
        children: Object.entries(categoryMap).map(([cat, levels]) => ({
          name: cat,
          children: Object.entries(levels).map(([level, books]) => ({
            name: level,
            children: books.map(b => ({
              name: b.title,
              id: b.id
            }))
          }))
        }))
      };

      // 기존 SVG 제거 후 새로 그림
      d3.select("#chart").selectAll("*").remove();

      const width = 900;
      const dx = 20;
      const dy = 200;

      const tree = d3.tree().nodeSize([dx, dy]);
      const root = d3.hierarchy(data);
      root.x0 = dy / 2;
      root.y0 = 0;
      tree(root);

      let x0 = Infinity;
      let x1 = -x0;
      root.each(d => {
        if (d.x > x1) x1 = d.x;
        if (d.x < x0) x0 = d.x;
      });

      const svg = d3.select("#chart").append("svg")
        .attr("viewBox", [-dy / 3, x0 - dx, width, x1 - x0 + dx * 2])
        .style("font", "12px sans-serif")
        .style("user-select", "none");

      const g = svg.append("g")
        .attr("transform", `translate(${dy / 3},${dx - x0})`);

      const link = g.append("g")
        .attr("fill", "none")
        .attr("stroke", "#ccc")
        .attr("stroke-opacity", 0.6)
        .attr("stroke-width", 1.5)
        .selectAll("path")
        .data(root.links())
        .join("path")
        .attr("d", d3.linkHorizontal()
          .x(d => d.y)
          .y(d => d.x));

      const node = g.append("g")
        .attr("stroke-linejoin", "round")
        .attr("stroke-width", 3)
        .selectAll("g")
        .data(root.descendants())
        .join("g")
        .attr("transform", d => `translate(${d.y},${d.x})`);

      node.append("circle")
        .attr("fill", d => d.children ? "#1d4ed8" : "#10b981")
        .attr("r", 5)
        .on("click", (event, d) => {
          if (!d.children && d.data.id) {
            window.location.href = `book-detail.html?id=${d.data.id}`;
          }
        });

      node.append("text")
        .attr("dy", "0.31em")
        .attr("x", d => d.children ? -10 : 10)
        .attr("text-anchor", d => d.children ? "end" : "start")
        .text(d => d.data.name)
        .clone(true).lower()
        .attr("stroke", "white");
    }

    loadData();
  </script>
</body>
</html>
