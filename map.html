<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BookMap — 북맵 관계도</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- 상단 네비게이션 -->
  <header class="bg-blue-600 text-white shadow">
    <div class="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
      <h1 class="text-xl font-bold">📚 BookMap</h1>
      <nav class="flex gap-6 text-sm">
        <a href="index.html" class="hover:underline">홈</a>
        <a href="form.html" class="hover:underline">도서 등록</a>
        <a href="book.html" class="hover:underline">북맵 리스트</a>
        <a href="map.html" class="hover:underline font-bold">북맵 보기</a>
      </nav>
    </div>
  </header>

  <!-- 메인 -->
  <main class="max-w-7xl mx-auto px-6 py-10">
    <h2 class="text-2xl font-bold mb-4">📖 도서 관계도</h2>
    <p class="text-sm text-gray-600 mb-6">
      북맵 관계도는 도서, 저자, 주제, 단계 등과 같은 관계에 따라 연결되는 것을 보여줍니다. 
      도서명이나 저자 이름에 마우스를 올리면 간단한 설명을 볼 수 있으며, 
      클릭하면 해당 도서 상세페이지로 이동합니다.
    </p>

    <!-- 필터 -->
    <section class="bg-white p-6 rounded-xl shadow mb-6">
      <h3 class="font-semibold mb-4">필터</h3>

      <div class="mb-4">
        <h4 class="text-sm font-medium mb-2">카테고리</h4>
        <div id="categoryFilter" class="flex flex-wrap gap-2"></div>
      </div>

      <div class="mb-4">
        <h4 class="text-sm font-medium mb-2">단계</h4>
        <div id="levelFilter" class="flex flex-wrap gap-2"></div>
      </div>

      <div class="mb-4">
        <h4 class="text-sm font-medium mb-2">도서구분</h4>
        <div id="divisionFilter" class="flex flex-wrap gap-2"></div>
      </div>

      <div class="mb-4">
        <h4 class="text-sm font-medium mb-2">저자</h4>
        <div id="authorFilter" class="flex flex-wrap gap-2"></div>
      </div>

      <div>
        <h4 class="text-sm font-medium mb-2">주제</h4>
        <div id="subjectFilter" class="flex flex-wrap gap-2"></div>
      </div>
    </section>

    <!-- 노드 색상 안내 -->
    <section class="bg-white p-4 rounded-xl shadow mb-6">
      <div class="flex flex-wrap gap-6 text-sm">
        <span class="flex items-center gap-2"><span class="w-3 h-3 bg-black rounded-full"></span>큰 주제 (theme)</span>
        <span class="flex items-center gap-2"><span class="w-3 h-3 bg-gray-600 rounded-full"></span>세부 주제 (subject)</span>
        <span class="flex items-center gap-2"><span class="w-3 h-3 bg-green-500 rounded-full"></span>저자 (author)</span>
        <span class="flex items-center gap-2"><span class="w-3 h-3 bg-blue-500 rounded-full"></span>카테고리 (category)</span>
        <span class="flex items-center gap-2"><span class="w-3 h-3 bg-purple-500 rounded-full"></span>도서구분 (division)</span>
        <span class="flex items-center gap-2"><span class="w-3 h-3 bg-red-500 rounded-full"></span>도서 (book)</span>
      </div>
    </section>

    <!-- 로딩 -->
    <div id="loading" class="text-center text-gray-500">⏳ 북맵 관계도를 로딩중입니다. 잠시만 기다려주세요. 감사합니다.</div>

    <!-- 그래프 -->
    <div id="graph" class="w-full h-[750px] bg-white rounded-xl shadow"></div>
  </main>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbywJOW4dOlmDrzood3ka_jizri4K7sFqTJDPG8ibnmDrxXZgFWrFnjMEv38C5pCtjp_/exec";
    let allBooks = [];
    let activeFilters = { category: [], level: [], division: [], author: [], subject: [] };

    async function loadBooks() {
      const res = await fetch(API_URL);
      allBooks = await res.json();

      renderFilters(allBooks);
      renderGraph(allBooks);
      document.getElementById("loading").classList.add("hidden");
    }

    function renderFilters(books) {
      const categories = new Set();
      const levels = new Set();
      const divisions = new Set();
      const authors = new Set();
      const subjects = new Set();

      books.forEach(b => {
        b.category?.split(",").map(c => categories.add(c.trim()));
        if (b.level) levels.add(b.level.trim());
        if (b.division) divisions.add(b.division.trim());
        if (b.author) authors.add(b.author.trim());
        if (b.subject) b.subject.split(",").map(s => subjects.add(s.trim()));
      });

      renderFilterButtons("categoryFilter", "category", [...categories]);
      renderFilterButtons("levelFilter", "level", [...levels]);
      renderFilterButtons("divisionFilter", "division", [...divisions]);
      renderFilterButtons("authorFilter", "author", [...authors]);
      renderFilterButtons("subjectFilter", "subject", [...subjects]);
    }

    function renderFilterButtons(containerId, type, items) {
      document.getElementById(containerId).innerHTML = items.map(item => `
        <button 
          id="${type}-${item}"
          class="px-3 py-1 border border-gray-300 rounded-full text-sm transition"
          onclick="toggleFilter('${type}','${item}')"
        >${item}</button>
      `).join("");
    }

    function toggleFilter(type, value) {
      const idx = activeFilters[type].indexOf(value);
      const button = document.getElementById(`${type}-${value}`);

      if (idx > -1) {
        activeFilters[type].splice(idx, 1);
        button.classList.remove("bg-blue-500", "text-white", "border-blue-500");
        button.classList.add("border-gray-300");
      } else {
        activeFilters[type].push(value);
        button.classList.remove("border-gray-300");
        button.classList.add("bg-blue-500", "text-white", "border-blue-500");
      }
      renderGraph(allBooks);
    }

    function renderGraph(books) {
      document.getElementById("graph").innerHTML = "";

      const filtered = books.filter(b => {
        const matchCategory = activeFilters.category.length === 0 || activeFilters.category.some(f => b.category?.includes(f));
        const matchLevel = activeFilters.level.length === 0 || activeFilters.level.includes(b.level);
        const matchDivision = activeFilters.division.length === 0 || activeFilters.division.includes(b.division);
        const matchAuthor = activeFilters.author.length === 0 || activeFilters.author.includes(b.author);
        const matchSubject = activeFilters.subject.length === 0 || activeFilters.subject.some(f => b.subject?.includes(f));
        return matchCategory && matchLevel && matchDivision && matchAuthor && matchSubject;
      });

      const nodes = [];
      const links = [];

      filtered.forEach(b => {
        const bookNode = { id: `book-${b.id}`, label: b.title, type: "book", desc: b.reason || "", link: `book-detail.html?id=${b.id}` };
        nodes.push(bookNode);

        if (b.author) {
          const authorId = `author-${b.author}`;
          if (!nodes.find(n => n.id === authorId)) nodes.push({ id: authorId, label: b.author, type: "author" });
          links.push({ source: bookNode.id, target: authorId });
        }
        if (b.category) {
          b.category.split(",").forEach(c => {
            const catId = `cat-${c.trim()}`;
            if (!nodes.find(n => n.id === catId)) nodes.push({ id: catId, label: c.trim(), type: "category" });
            links.push({ source: bookNode.id, target: catId });
          });
        }
        if (b.level) {
          const lvlId = `level-${b.level}`;
          if (!nodes.find(n => n.id === lvlId)) nodes.push({ id: lvlId, label: b.level, type: "level" });
          links.push({ source: bookNode.id, target: lvlId });
        }
        if (b.division) {
          const divId = `div-${b.division}`;
          if (!nodes.find(n => n.id === divId)) nodes.push({ id: divId, label: b.division, type: "division" });
          links.push({ source: bookNode.id, target: divId });
        }
        if (b.subject) {
          b.subject.split(",").forEach(s => {
            const subId = `sub-${s.trim()}`;
            if (!nodes.find(n => n.id === subId)) nodes.push({ id: subId, label: s.trim(), type: "subject" });
            links.push({ source: bookNode.id, target: subId });
          });
        }
        if (b.theme) {
          const themeId = `theme-${b.theme}`;
          if (!nodes.find(n => n.id === themeId)) nodes.push({ id: themeId, label: b.theme, type: "theme" });
          links.push({ source: bookNode.id, target: themeId });
        }
      });

      const colorMap = {
        theme: "black",
        subject: "gray",
        author: "green",
        category: "blue",
        division: "purple",
        book: "red"
      };

      const svg = d3.select("#graph").append("svg")
        .attr("width", "100%")
        .attr("height", "100%")
        .attr("viewBox", [0, 0, document.getElementById("graph").clientWidth, 750]);

      const simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(120))
        .force("charge", d3.forceManyBody().strength(-400))
        .force("center", d3.forceCenter(document.getElementById("graph").clientWidth / 2, 375));

      const link = svg.append("g")
        .attr("stroke", "#aaa")
        .selectAll("line")
        .data(links)
        .join("line")
        .attr("stroke-width", 1);

      const node = svg.append("g")
        .selectAll("circle")
        .data(nodes)
        .join("circle")
        .attr("r", 8)
        .attr("fill", d => colorMap[d.type])
        .call(drag(simulation));

      const label = svg.append("g")
        .selectAll("text")
        .data(nodes)
        .join("text")
        .text(d => d.label)
        .attr("font-size", 11)
        .attr("dx", 12)
        .attr("dy", 4);

      const tooltip = d3.select("body").append("div")
        .attr("class", "absolute bg-white border border-gray-300 text-xs p-2 rounded shadow hidden");

      node.on("mouseover", (event, d) => {
        tooltip.html(`<b>${d.label}</b><br>${d.desc || ""}`)
          .style("left", (event.pageX + 10) + "px")
          .style("top", (event.pageY - 20) + "px")
          .classed("hidden", false);
      }).on("mouseout", () => tooltip.classed("hidden", true))
        .on("click", (event, d) => {
          if (d.type === "book") window.location.href = d.link;
        });

      simulation.on("tick", () => {
        link.attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);

        node.attr("cx", d => d.x).attr("cy", d => d.y);
        label.attr("x", d => d.x).attr("y", d => d.y);
      });

      function drag(simulation) {
        return d3.drag()
          .on("start", (event, d) => {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x; d.fy = d.y;
          })
          .on("drag", (event, d) => {
            d.fx = event.x; d.fy = event.y;
          })
          .on("end", (event, d) => {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null; d.fy = null;
          });
      }
    }

    loadBooks();
  </script>
</body>
</html>
