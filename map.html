<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BookMap — 관계도</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- 상단 네비게이션 -->
  <header class="bg-blue-600 text-white shadow">
    <div class="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
      <h1 class="text-xl font-bold">📚 BookMap</h1>
      <nav class="flex gap-6 text-sm">
        <a href="index.html" class="hover:underline">홈</a>
        <a href="form.html" class="hover:underline">도서 등록</a>
        <a href="book.html" class="hover:underline">북맵 리스트</a>
        <a href="map.html" class="hover:underline">북맵 보기</a>
      </nav>
    </div>
  </header>

  <!-- 메인 -->
  <main class="max-w-6xl mx-auto px-6 py-10">
    <h2 class="text-2xl font-bold mb-6">📖 도서 관계도</h2>

    <!-- 필터 -->
    <section class="bg-white p-6 rounded-xl shadow mb-6">
      <h3 class="font-semibold mb-4">필터</h3>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <h4 class="text-sm font-medium mb-2">카테고리</h4>
          <div id="categoryFilter" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <h4 class="text-sm font-medium mb-2">단계</h4>
          <div id="levelFilter" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <h4 class="text-sm font-medium mb-2">도서구분</h4>
          <div id="divisionFilter" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <h4 class="text-sm font-medium mb-2">저자</h4>
          <div id="authorFilter" class="flex flex-wrap gap-2"></div>
        </div>
      </div>

      <!-- 노드 색상 안내 -->
      <div class="mt-4 text-sm text-gray-600 flex flex-wrap gap-4">
        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-blue-600"></span> 카테고리/단계 노드</span>
        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-green-600"></span> 도서 노드</span>
        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-black"></span> 주제 노드</span>
      </div>
    </section>

    <!-- 로딩 표시 -->
    <div id="loading" class="text-center text-gray-500 py-20">
      ⏳ 북맵 관계도를 로딩중입니다. 잠시만 기다려주세요. 감사합니다.
    </div>

    <!-- 관계도 -->
    <section id="graphContainer" class="bg-white p-6 rounded-xl shadow">
      <svg id="graph" width="100%" height="700"></svg>
    </section>
  </main>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbywJOW4dOlmDrzood3ka_jizri4K7sFqTJDPG8ibnmDrxXZgFWrFnjMEv38C5pCtjp_/exec";

    let allBooks = [];
    let selectedCategories = new Set();
    let selectedLevels = new Set();
    let selectedDivisions = new Set();
    let selectedAuthors = new Set();

    async function loadBooks() {
      try {
        const res = await fetch(API_URL);
        allBooks = await res.json();

        document.getElementById("loading").classList.add("hidden");

        renderFilters();
        renderGraph();
      } catch (err) {
        console.error("데이터 불러오기 실패:", err);
        document.getElementById("loading").innerText = "❌ 데이터를 불러오는 중 오류가 발생했습니다.";
      }
    }

    function renderFilters() {
      const categories = new Set();
      const levels = new Set();
      const divisions = new Set(["국내서","원서","번역서"]);
      const authors = new Set();

      allBooks.forEach(book => {
        (Array.isArray(book.category) ? book.category : String(book.category).split(","))
          .map(c => c.trim()).forEach(c => categories.add(c));
        if (book.level) levels.add(book.level);
        if (book.division) divisions.add(book.division);
        if (book.author) authors.add(book.author);
      });

      const categoryFilter = document.getElementById("categoryFilter");
      categoryFilter.innerHTML = Array.from(categories).map(cat => `
        <button onclick="toggleFilter('category','${cat}')" class="px-3 py-1 border rounded-full text-sm">${cat}</button>
      `).join("");

      const levelFilter = document.getElementById("levelFilter");
      levelFilter.innerHTML = Array.from(levels).map(level => `
        <button onclick="toggleFilter('level','${level}')" class="px-3 py-1 border rounded-full text-sm">${level}</button>
      `).join("");

      const divisionFilter = document.getElementById("divisionFilter");
      divisionFilter.innerHTML = Array.from(divisions).map(div => `
        <button onclick="toggleFilter('division','${div}')" class="px-3 py-1 border rounded-full text-sm">${div}</button>
      `).join("");

      const authorFilter = document.getElementById("authorFilter");
      authorFilter.innerHTML = Array.from(authors).map(author => `
        <button onclick="toggleFilter('author','${author}')" class="px-3 py-1 border rounded-full text-sm">${author}</button>
      `).join("");
    }

    function toggleFilter(type, value) {
      let set;
      if (type === "category") set = selectedCategories;
      if (type === "level") set = selectedLevels;
      if (type === "division") set = selectedDivisions;
      if (type === "author") set = selectedAuthors;

      if (set.has(value)) set.delete(value);
      else set.add(value);

      renderGraph();
    }

    function renderGraph() {
      const svg = d3.select("#graph");
      svg.selectAll("*").remove();

      const width = document.getElementById("graphContainer").offsetWidth;
      const height = 700;

      // 필터링된 도서
      const filtered = allBooks.filter(book => {
        const cats = Array.isArray(book.category) ? book.category : String(book.category).split(",").map(c=>c.trim());
        const categoryMatch = selectedCategories.size === 0 || cats.some(c => selectedCategories.has(c));
        const levelMatch = selectedLevels.size === 0 || selectedLevels.has(book.level);
        const divisionMatch = selectedDivisions.size === 0 || selectedDivisions.has(book.division);
        const authorMatch = selectedAuthors.size === 0 || selectedAuthors.has(book.author);
        return categoryMatch && levelMatch && divisionMatch && authorMatch;
      });

      // 노드/링크 생성
      let nodes = [];
      let links = [];

      const nodeMap = new Map();
      function addNode(id, label, group) {
        if (!nodeMap.has(id)) {
          const node = { id, label, group };
          nodeMap.set(id, node);
          nodes.push(node);
        }
      }

      filtered.forEach(book => {
        const cats = Array.isArray(book.category) ? book.category : String(book.category).split(",").map(c=>c.trim());
        cats.forEach(cat => {
          addNode(cat, cat, "category");
          addNode(book.id, book.title, "book");
          links.push({ source: cat, target: book.id });
        });

        if (book.level) {
          addNode(book.level, book.level, "level");
          links.push({ source: book.level, target: book.id });
        }

        if (book.division) {
          addNode(book.division, book.division, "division");
          links.push({ source: book.division, target: book.id });
        }

        if (book.subject) {
          const subjects = Array.isArray(book.subject) ? book.subject : String(book.subject).split(",").map(s=>s.trim());
          subjects.forEach(sub => {
            addNode(sub, sub, "subject");
            links.push({ source: sub, target: book.id });
          });
        }

        if (book.author) {
          addNode(book.author, book.author, "author");
          links.push({ source: book.author, target: book.id });
        }
      });

      // Force simulation
      const simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(120))
        .force("charge", d3.forceManyBody().strength(-400))
        .force("center", d3.forceCenter(width / 2, height / 2));

      // Links
      svg.append("g")
        .attr("stroke", "#aaa")
        .selectAll("line")
        .data(links)
        .enter().append("line");

      // Nodes
      const color = d => {
        if (d.group === "book") return "#16a34a"; // green
        if (d.group === "subject") return "#000000"; // black
        if (d.group === "author") return "#f97316"; // orange
        return "#2563eb"; // category/level/division → blue
      };

      const node = svg.append("g")
        .selectAll("circle")
        .data(nodes)
        .enter().append("circle")
        .attr("r", 8)
        .attr("fill", color)
        .call(drag(simulation))
        .on("click", (event, d) => {
          if (d.group === "book") {
            window.location.href = `book-detail.html?id=${d.id}`;
          }
        });

      // Labels
      const label = svg.append("g")
        .selectAll("text")
        .data(nodes)
        .enter().append("text")
        .text(d => d.label)
        .attr("font-size", 12)
        .attr("dy", -12);

      simulation.on("tick", () => {
        svg.selectAll("line")
          .attr("x1", d => d.source.x)
          .attr("y1", d => d.source.y)
          .attr("x2", d => d.target.x)
          .attr("y2", d => d.target.y);

        node.attr("cx", d => d.x).attr("cy", d => d.y);
        label.attr("x", d => d.x).attr("y", d => d.y);
      });

      function drag(simulation) {
        function dragstarted(event, d) {
          if (!event.active) simulation.alphaTarget(0.3).restart();
          d.fx = d.x;
          d.fy = d.y;
        }
        function dragged(event, d) {
          d.fx = event.x;
          d.fy = event.y;
        }
        function dragended(event, d) {
          if (!event.active) simulation.alphaTarget(0);
          d.fx = null;
          d.fy = null;
        }
        return d3.drag()
          .on("start", dragstarted)
          .on("drag", dragged)
          .on("end", dragended);
      }
    }

    loadBooks();
  </script>
</body>
</html>
