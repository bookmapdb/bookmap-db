<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>📚 BookMap — 관계도</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- 헤더 -->
  <header class="bg-blue-600 text-white shadow">
    <div class="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
      <h1 class="text-xl font-bold">📚 BookMap</h1>
      <nav class="flex gap-6">
        <a href="index.html" class="hover:underline">홈</a>
        <a href="form.html" class="hover:underline">도서 등록</a>
        <a href="book.html" class="hover:underline">북맵 리스트</a>
        <a href="map.html" class="hover:underline">북맵 보기</a>
      </nav>
    </div>
  </header>

  <!-- 설명 -->
  <main class="max-w-6xl mx-auto px-6 py-8">
    <p class="mb-4 text-gray-700">
      북맵 관계도는 <strong>도서, 저자, 주제, 단계</strong> 등과 같은 관계에 따라 연결되는 것을 보여줍니다.<br>
      <span class="text-blue-600">도서명이나 저자 이름에 마우스를 올리면 간단한 설명</span>을 볼 수 있으며,  
      <span class="text-green-600">클릭하면 해당 도서 상세페이지로 이동</span>합니다.
    </p>

    <!-- 필터 UI -->
    <div id="filters" class="grid grid-cols-5 gap-4 mb-6 text-sm"></div>

    <!-- 노드 색상 안내 -->
    <div class="flex gap-4 mb-6 text-xs text-gray-600">
      <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-red-400"></span> 큰 주제</div>
      <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-orange-400"></span> 세부 주제</div>
      <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-yellow-400"></span> 저자</div>
      <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-green-400"></span> 카테고리</div>
      <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-blue-400"></span> 도서구분</div>
      <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-purple-400"></span> 도서</div>
    </div>

    <!-- 로딩 안내 -->
    <div id="loading" class="text-center text-gray-500">📊 북맵 관계도를 로딩중입니다. 잠시만 기다려주세요...</div>

    <!-- 그래프 -->
    <div id="graph" class="w-full h-[700px] bg-white shadow rounded-lg"></div>
  </main>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwcJ2aaqVvEhxcGdJakKjsmizPBNXzScw2NVWsQ2VNammR0bncJpk68NOYcjgUW6wOf/exec";

    let allBooks = [];
    let activeFilters = { category: null, level: null, division: null, author: null, subject: null };

    // ✅ 필터 UI 생성
    function createFilters(books) {
      const filterContainer = document.getElementById("filters");
      filterContainer.innerHTML = "";

      const categories = [...new Set(books.map(b => b.category).filter(Boolean))];
      const levels = [...new Set(books.map(b => b.level).filter(Boolean))];
      const divisions = [...new Set(books.map(b => b.division).filter(Boolean))];
      const authors = [...new Set(books.map(b => b.author).filter(Boolean))];
      const subjects = [...new Set(books.flatMap(b => (Array.isArray(b.subject) ? b.subject : (b.subject ? b.subject.split(",") : []))).map(s => s.trim()).filter(Boolean))];

      const filterDefs = [
        { key: "category", label: "카테고리", values: categories },
        { key: "level", label: "단계", values: levels },
        { key: "division", label: "도서구분", values: divisions },
        { key: "author", label: "저자", values: authors },
        { key: "subject", label: "주제", values: subjects }
      ];

      filterDefs.forEach(filter => {
        const section = document.createElement("div");
        section.innerHTML = `<h3 class="font-bold mb-2">${filter.label}</h3>`;
        const btnContainer = document.createElement("div");
        btnContainer.className = "flex flex-wrap gap-2";

        filter.values.forEach(val => {
          const btn = document.createElement("button");
          btn.textContent = val;
          btn.className = "px-2 py-1 rounded border text-xs bg-gray-100 hover:bg-blue-100";
          btn.onclick = () => {
            activeFilters[filter.key] = activeFilters[filter.key] === val ? null : val;
            renderGraph();
            updateFilterUI();
          };
          btnContainer.appendChild(btn);
        });

        section.appendChild(btnContainer);
        filterContainer.appendChild(section);
      });
    }

    function updateFilterUI() {
      document.querySelectorAll("#filters button").forEach(btn => {
        const parentLabel = btn.closest("div").previousSibling.textContent.trim();
        const key = parentLabel === "카테고리" ? "category" : 
                    parentLabel === "단계" ? "level" : 
                    parentLabel === "도서구분" ? "division" : 
                    parentLabel === "저자" ? "author" : "subject";
        btn.classList.toggle("bg-blue-600", activeFilters[key] === btn.textContent);
        btn.classList.toggle("text-white", activeFilters[key] === btn.textContent);
      });
    }

    // ✅ 필터 적용
    function applyFilters(books) {
      return books.filter(b =>
        (!activeFilters.category || b.category === activeFilters.category) &&
        (!activeFilters.level || b.level === activeFilters.level) &&
        (!activeFilters.division || b.division === activeFilters.division) &&
        (!activeFilters.author || b.author === activeFilters.author) &&
        (!activeFilters.subject || (Array.isArray(b.subject) ? b.subject.includes(activeFilters.subject) : (b.subject || "").includes(activeFilters.subject)))
      );
    }

    // ✅ 그래프 렌더링
    function renderGraph() {
      const books = applyFilters(allBooks);
      const nodes = [];
      const links = [];

      books.forEach(book => {
        nodes.push({ id: book.title, group: "도서", description: book.description, url: `detail.html?title=${encodeURIComponent(book.title)}` });
        if (book.author) {
          nodes.push({ id: book.author, group: "저자" });
          links.push({ source: book.title, target: book.author });
        }
        if (book.theme) {
          nodes.push({ id: book.theme, group: "큰 주제" });
          links.push({ source: book.title, target: book.theme });
        }
        if (book.category) {
          nodes.push({ id: book.category, group: "카테고리" });
          links.push({ source: book.title, target: book.category });
        }
        if (book.division) {
          nodes.push({ id: book.division, group: "도서구분" });
          links.push({ source: book.title, target: book.division });
        }
        if (book.subject) {
          const subjects = Array.isArray(book.subject) ? book.subject : book.subject.split(",");
          subjects.forEach(s => {
            const sub = s.trim();
            if (sub) {
              nodes.push({ id: sub, group: "세부 주제" });
              links.push({ source: book.title, target: sub });
            }
          });
        }
      });

      const uniqueNodes = Array.from(new Map(nodes.map(n => [n.id, n])).values());

      const colorMap = {
        "큰 주제": "red",
        "세부 주제": "orange",
        "저자": "yellow",
        "카테고리": "green",
        "도서구분": "blue",
        "도서": "purple"
      };

      d3.select("#graph").selectAll("*").remove();

      const width = document.getElementById("graph").clientWidth;
      const height = document.getElementById("graph").clientHeight;

      const svg = d3.select("#graph").append("svg")
        .attr("width", width)
        .attr("height", height)
        .call(d3.zoom().on("zoom", (event) => {
          svg.attr("transform", event.transform);
        }))
        .append("g");

      const simulation = d3.forceSimulation(uniqueNodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(120))
        .force("charge", d3.forceManyBody().strength(-400))
        .force("center", d3.forceCenter(width / 2, height / 2));

      const link = svg.append("g")
        .attr("stroke", "#aaa")
        .selectAll("line")
        .data(links)
        .enter().append("line");

      const node = svg.append("g")
        .selectAll("circle")
        .data(uniqueNodes)
        .enter().append("circle")
        .attr("r", 18)
        .attr("fill", d => colorMap[d.group] || "gray")
        .call(drag(simulation));

      const label = svg.append("g")
        .selectAll("text")
        .data(uniqueNodes)
        .enter().append("text")
        .text(d => d.id)
        .attr("font-size", "10px")
        .attr("dx", 22)
        .attr("dy", ".35em");

      node.append("title").text(d => d.description || d.group);

      node.on("click", (event, d) => {
        if (d.url) {
          window.location.href = d.url;
        }
      });

      simulation.on("tick", () => {
        link
          .attr("x1", d => d.source.x)
          .attr("y1", d => d.source.y)
          .attr("x2", d => d.target.x)
          .attr("y2", d => d.target.y);

        node
          .attr("cx", d => d.x)
          .attr("cy", d => d.y);

        label
          .attr("x", d => d.x)
          .attr("y", d => d.y);
      });

      function drag(simulation) {
        return d3.drag()
          .on("start", (event, d) => {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
          })
          .on("drag", (event, d) => {
            d.fx = event.x;
            d.fy = event.y;
          })
          .on("end", (event, d) => {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
          });
      }

      document.getElementById("loading").classList.add("hidden");
    }

    // ✅ 데이터 불러오기
    fetch(API_URL)
      .then(res => res.json())
      .then(data => {
        allBooks = data;
        createFilters(allBooks);
        renderGraph();
      })
      .catch(err => {
        console.error(err);
        document.getElementById("loading").textContent = "⚠️ 데이터를 불러오는 중 오류가 발생했습니다.";
      });
  </script>
</body>
</html>
