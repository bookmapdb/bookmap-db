<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>BookMap — 관계도</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- 상단 네비게이션 -->
  <header class="bg-blue-600 text-white shadow">
    <div class="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
      <h1 class="text-xl font-bold">📚 BookMap</h1>
      <nav class="flex gap-4">
        <a href="index.html" class="hover:underline">홈</a>
        <a href="add.html" class="hover:underline">도서 등록</a>
        <a href="book.html" class="hover:underline">북맵 리스트</a>
        <a href="map.html" class="hover:underline font-bold">북맵 보기</a>
      </nav>
    </div>
  </header>

  <!-- 안내 -->
  <main class="max-w-6xl mx-auto p-6">
    <h2 class="text-2xl font-bold mb-4">📖 도서 관계도</h2>
    <p class="mb-6 text-gray-700">
      북맵 관계도는 도서, 저자, 주제, 단계 등과 같은 관계에 따라 연결되는 것을 보여줍니다.<br>
      도서명이나 저자 이름에 마우스를 올리면 간단한 설명을 볼 수 있으며, 
      <span class="font-bold text-blue-600">클릭하면 해당 도서 상세페이지</span>로 이동합니다.
    </p>

    <!-- 필터 -->
    <div class="bg-white rounded-xl shadow p-4 mb-4">
      <h3 class="font-semibold mb-2">필터</h3>
      <div id="filter-category" class="flex flex-wrap gap-2 mb-2"></div>
      <div id="filter-level" class="flex flex-wrap gap-2 mb-2"></div>
      <div id="filter-division" class="flex flex-wrap gap-2 mb-2"></div>
      <div id="filter-author" class="flex flex-wrap gap-2 mb-2"></div>
      <div id="filter-subject" class="flex flex-wrap gap-2"></div>
    </div>

    <!-- 노드 색상 안내 -->
    <div class="bg-white rounded-xl shadow p-4 mb-6">
      <h3 class="font-semibold mb-2">🎨 노드 색상 안내</h3>
      <div class="flex flex-wrap gap-6 text-sm">
        <span class="flex items-center"><span class="w-3 h-3 bg-black rounded-full mr-2"></span>큰 주제 (theme)</span>
        <span class="flex items-center"><span class="w-3 h-3 bg-gray-500 rounded-full mr-2"></span>세부 주제 (subject)</span>
        <span class="flex items-center"><span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>저자 (author)</span>
        <span class="flex items-center"><span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>카테고리 (category)</span>
        <span class="flex items-center"><span class="w-3 h-3 bg-purple-500 rounded-full mr-2"></span>도서구분 (division)</span>
      </div>
    </div>

    <!-- 로딩 메시지 -->
    <div id="loading" class="text-center text-gray-600 my-6">
      ⏳ 북맵 관계도를 로딩중입니다. 잠시만 기다려주세요. 감사합니다.
    </div>

    <!-- 그래프 영역 -->
    <div id="graph" class="w-full h-[80vh] bg-white rounded-xl shadow"></div>
  </main>

  <script>
    const width = document.getElementById("graph").clientWidth;
    const height = document.getElementById("graph").clientHeight;

    const svg = d3.select("#graph").append("svg")
      .attr("width", "100%")
      .attr("height", "100%")
      .attr("viewBox", [0, 0, width, height]);

    d3.json("books.json").then(data => {
      document.getElementById("loading").style.display = "none";

      const nodes = [];
      const links = [];

      data.forEach(book => {
        const bookNode = { id: book.title, type: "book", description: book.description, link: `book-detail.html?id=${book.id}` };
        nodes.push(bookNode);

        if (book.author) {
          nodes.push({ id: book.author, type: "author" });
          links.push({ source: book.title, target: book.author });
        }
        if (book.theme) {
          nodes.push({ id: book.theme, type: "theme" });
          links.push({ source: book.title, target: book.theme });
        }
        if (book.subject) {
          book.subject.split(",").forEach(s => {
            nodes.push({ id: s.trim(), type: "subject" });
            links.push({ source: book.title, target: s.trim() });
          });
        }
        if (book.category) {
          book.category.split(",").forEach(c => {
            nodes.push({ id: c.trim(), type: "category" });
            links.push({ source: book.title, target: c.trim() });
          });
        }
        if (book.division) {
          nodes.push({ id: book.division, type: "division" });
          links.push({ source: book.title, target: book.division });
        }
      });

      const nodeColor = {
        "theme": "black",
        "subject": "gray",
        "author": "green",
        "category": "blue",
        "division": "purple",
        "book": "red"
      };

      const simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(120))
        .force("charge", d3.forceManyBody().strength(-250))
        .force("center", d3.forceCenter(width / 2, height / 2));

      const link = svg.append("g")
        .selectAll("line")
        .data(links)
        .join("line")
        .attr("stroke", "#ccc");

      const node = svg.append("g")
        .selectAll("circle")
        .data(nodes)
        .join("circle")
        .attr("r", 8)
        .attr("fill", d => nodeColor[d.type] || "red")
        .call(drag(simulation));

      node.append("title").text(d => `${d.id}\n${d.description || ""}`);

      node.on("click", (event, d) => {
        if (d.type === "book") {
          window.location.href = d.link;
        }
      });

      const label = svg.append("g")
        .selectAll("text")
        .data(nodes)
        .join("text")
        .text(d => d.type === "book" ? d.id : "")
        .attr("font-size", 10)
        .attr("dx", 12)
        .attr("dy", 4);

      simulation.on("tick", () => {
        link.attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);

        node.attr("cx", d => d.x).attr("cy", d => d.y);
        label.attr("x", d => d.x).attr("y", d => d.y);
      });

      function drag(simulation) {
        return d3.drag()
          .on("start", event => {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            event.subject.fx = event.subject.x;
            event.subject.fy = event.subject.y;
          })
          .on("drag", event => {
            event.subject.fx = event.x;
            event.subject.fy = event.y;
          })
          .on("end", event => {
            if (!event.active) simulation.alphaTarget(0);
            event.subject.fx = null;
            event.subject.fy = null;
          });
      }
    });
  </script>
</body>
</html>
