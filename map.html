<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BookMap â€” ë„ì„œ ê´€ê³„ë„</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <header class="bg-blue-600 text-white shadow">
    <div class="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
      <h1 class="text-xl font-bold">ğŸ“š BookMap</h1>
      <nav class="flex gap-6 text-sm">
        <a href="index.html" class="hover:underline">í™ˆ</a>
        <a href="form.html" class="hover:underline">ë„ì„œ ë“±ë¡</a>
        <a href="book.html" class="hover:underline">ë¶ë§µ ë¦¬ìŠ¤íŠ¸</a>
        <a href="map.html" class="hover:underline font-bold">ë¶ë§µ ë³´ê¸°</a>
      </nav>
    </div>
  </header>

  <!-- ë©”ì¸ -->
  <main class="max-w-6xl mx-auto px-6 py-10">
    <h2 class="text-2xl font-bold mb-4">ğŸ“– ë„ì„œ ê´€ê³„ë„</h2>
    <p class="mb-6 text-gray-600">
      ë¶ë§µ ê´€ê³„ë„ëŠ” ë„ì„œ, ì €ì, ì£¼ì œ, ë‹¨ê³„ ë“±ê³¼ ê°™ì€ ê´€ê³„ì— ë”°ë¼ ì—°ê²°ë˜ëŠ” ê²ƒì„ ë³´ì—¬ì¤ë‹ˆë‹¤. 
      ë„ì„œëª…ì´ë‚˜ ì €ì ì´ë¦„ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ê°„ë‹¨í•œ ì„¤ëª…ì„ ë³¼ ìˆ˜ ìˆìœ¼ë©°, 
      í´ë¦­í•˜ì‹œë©´ í•´ë‹¹ ë„ì„œ ìƒì„¸í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.
    </p>

    <!-- í•„í„° -->
    <section class="bg-white p-4 rounded-lg shadow mb-4">
      <div class="flex flex-wrap gap-4 items-center">
        <div>
          <h3 class="font-semibold mb-1">ì¹´í…Œê³ ë¦¬</h3>
          <div id="filter-category" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <h3 class="font-semibold mb-1">ë‹¨ê³„</h3>
          <div id="filter-level" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <h3 class="font-semibold mb-1">ë„ì„œêµ¬ë¶„</h3>
          <div id="filter-division" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <h3 class="font-semibold mb-1">ì €ì</h3>
          <div id="filter-author" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <h3 class="font-semibold mb-1">ì£¼ì œ</h3>
          <div id="filter-subject" class="flex flex-wrap gap-2"></div>
        </div>
      </div>
    </section>

    <!-- ë…¸ë“œ ìƒ‰ìƒ ì•ˆë‚´ -->
    <section class="bg-gray-100 p-3 rounded mb-4 flex gap-6 text-sm">
      <span>âš« í° ì£¼ì œ (ê²€ì€ìƒ‰)</span>
      <span style="color:#8B4513">âš« ì„¸ë¶€ ì£¼ì œ (ë¸Œë¼ìš´)</span>
      <span style="color:#1E3A8A">âš« ì €ì (íŒŒë€ìƒ‰)</span>
      <span style="color:#F59E0B">âš« ì¹´í…Œê³ ë¦¬ (ì£¼í™©ìƒ‰)</span>
      <span style="color:#10B981">âš« ë„ì„œêµ¬ë¶„ (ì´ˆë¡ìƒ‰)</span>
      <span style="color:#6B7280">âš« ë„ì„œ (íšŒìƒ‰)</span>
    </section>

    <!-- ë¡œë”© ì•ˆë‚´ -->
    <div id="loading" class="text-center text-gray-500 my-6">
      â³ ë¶ë§µ ê´€ê³„ë„ë¥¼ ë¡œë”©ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”. ê°ì‚¬í•©ë‹ˆë‹¤.
    </div>

    <!-- ê·¸ë˜í”„ -->
    <div id="graph" class="bg-white rounded-lg shadow p-2"></div>
  </main>

  <script>
    // ìƒ‰ìƒ ë§¤í•‘
    const colorScale = {
      theme: "#333333",
      subject: "#8B4513",
      author: "#1E3A8A",
      category: "#F59E0B",
      division: "#10B981",
      book: "#6B7280"
    };

    // SVG ë° ê·¸ë£¹
    const svg = d3.select("#graph").append("svg")
      .attr("width", "100%")
      .attr("height", 600);

    const g = svg.append("g");

    // ì¤Œ / íŒ¬ ê¸°ëŠ¥
    svg.call(
      d3.zoom().scaleExtent([0.1, 4])
        .on("zoom", (event) => g.attr("transform", event.transform))
    );

    const simulation = d3.forceSimulation()
      .force("link", d3.forceLink().id(d => d.id).distance(150))
      .force("charge", d3.forceManyBody().strength(-400))
      .force("center", d3.forceCenter(window.innerWidth / 2, 300));

    // ë°ì´í„° ë¡œë“œ
    fetch("books.json")
      .then(res => res.json())
      .then(data => {
        document.getElementById("loading").style.display = "none";

        const nodes = [];
        const links = [];

        data.forEach(book => {
          const bookNode = { id: book.title, type: "book" };
          nodes.push(bookNode);

          if (book.author) {
            nodes.push({ id: book.author, type: "author" });
            links.push({ source: book.title, target: book.author });
          }
          if (book.category) {
            book.category.split(",").map(c => c.trim()).forEach(cat => {
              nodes.push({ id: cat, type: "category" });
              links.push({ source: book.title, target: cat });
            });
          }
          if (book.level) {
            nodes.push({ id: book.level, type: "division" });
            links.push({ source: book.title, target: book.level });
          }
          if (book.theme) {
            nodes.push({ id: book.theme, type: "theme" });
            links.push({ source: book.title, target: book.theme });
          }
          if (book.subject) {
            (Array.isArray(book.subject) ? book.subject : [book.subject])
              .forEach(sub => {
                nodes.push({ id: sub, type: "subject" });
                links.push({ source: book.title, target: sub });
              });
          }
        });

        // ì¤‘ë³µ ì œê±°
        const uniqueNodes = Array.from(new Map(nodes.map(n => [n.id, n])).values());

        // ë§í¬
        const link = g.append("g")
          .attr("stroke", "#ccc")
          .selectAll("line")
          .data(links)
          .enter().append("line")
          .attr("stroke-width", 1.5);

        // ë…¸ë“œ
        const node = g.selectAll("circle")
          .data(uniqueNodes)
          .enter().append("circle")
          .attr("r", 20)
          .attr("fill", d => colorScale[d.type] || "#999")
          .call(drag(simulation));

        // í…ìŠ¤íŠ¸ ë¼ë²¨
        const label = g.selectAll("text")
          .data(uniqueNodes)
          .enter().append("text")
          .text(d => d.id)
          .attr("text-anchor", "middle")
          .attr("dy", 4)
          .attr("fill", "#fff")
          .style("pointer-events", "none")
          .style("font-size", "12px");

        simulation
          .nodes(uniqueNodes)
          .on("tick", ticked);

        simulation.force("link")
          .links(links);

        function ticked() {
          link
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);

          node
            .attr("cx", d => d.x)
            .attr("cy", d => d.y);

          label
            .attr("x", d => d.x)
            .attr("y", d => d.y);
        }
      });

    // ë“œë˜ê·¸
    function drag(simulation) {
      function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
      }
      function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
      }
      function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
      }
      return d3.drag()
        .on("start", dragstarted)
        .on("drag", dragged)
        .on("end", dragended);
    }
  </script>
</body>
</html>
