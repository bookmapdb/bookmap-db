<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BookMap — 북맵 관계도</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- 상단 네비게이션 -->
  <header class="bg-blue-600 text-white shadow">
    <div class="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
      <h1 class="text-xl font-bold">📚 BookMap</h1>
      <nav class="flex gap-6 text-sm">
        <a href="index.html" class="hover:underline">홈</a>
        <a href="form.html" class="hover:underline">도서 등록</a>
        <a href="book.html" class="hover:underline">북맵 리스트</a>
        <a href="map.html" class="hover:underline">북맵 관계도</a>
      </nav>
    </div>
  </header>

  <!-- 메인 -->
  <main class="max-w-7xl mx-auto px-6 py-10">
    <h2 class="text-2xl font-bold mb-6">북맵 관계도</h2>

    <!-- 안내문구 -->
    <p class="text-gray-600 mb-4">
      북맵 관계도는, <b>도서</b>, <b>저자</b>, <b>주제</b>, <b>단계</b> 등과 같은 관계에 따라 연결되는 것을 보여줍니다.<br>
      도서명이나 저자 이름에 마우스를 올리면 간단한 설명을 볼 수 있으며, 클릭하면 해당 도서 상세 페이지로 이동합니다.
    </p>

    <!-- 필터 -->
    <section class="bg-white p-4 rounded-xl shadow mb-6">
      <h3 class="font-semibold mb-3">필터</h3>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <h4 class="text-sm font-medium mb-2">카테고리</h4>
          <div id="categoryFilter" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <h4 class="text-sm font-medium mb-2">단계</h4>
          <div id="levelFilter" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <h4 class="text-sm font-medium mb-2">도서구분</h4>
          <div id="divisionFilter" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <h4 class="text-sm font-medium mb-2">저자</h4>
          <div id="authorFilter" class="flex flex-wrap gap-2"></div>
        </div>
      </div>
    </section>

    <!-- 노드 색상 안내 -->
    <section class="bg-gray-100 p-3 rounded-lg shadow mb-6">
      <div class="flex flex-wrap gap-4 text-sm">
        <span>⬤ <b class="text-black">큰 주제</b></span>
        <span>⬤ <b class="text-gray-700">세부 주제</b></span>
        <span>⬤ <b class="text-blue-600">저자</b></span>
        <span>⬤ <b class="text-green-600">카테고리</b></span>
        <span>⬤ <b class="text-purple-600">도서구분</b></span>
        <span>⬤ <b class="text-orange-500">도서</b></span>
      </div>
    </section>

    <!-- 로딩 -->
    <div id="loading" class="text-center text-gray-500 py-6">
      ⏳ 북맵 관계도를 로딩중입니다. 잠시만 기다려주세요...
    </div>

    <!-- 그래프 영역 -->
    <div id="graph" class="w-full h-[700px] border rounded-xl bg-white shadow"></div>
  </main>

  <script>
    const API_URL = "books.json"; // 로컬 JSON

    let selectedCategories = new Set();
    let selectedLevels = new Set();
    let selectedDivisions = new Set();
    let selectedAuthors = new Set();

    async function loadGraph() {
      const res = await fetch(API_URL);
      const books = await res.json();

      document.getElementById("loading").classList.add("hidden");

      renderFilters(books);
      renderGraph(books);
    }

    function renderFilters(books) {
      const categories = new Set();
      const levels = new Set();
      const divisions = new Set();
      const authors = new Set();

      books.forEach(book => {
        if (book.category) book.category.split(",").map(c => c.trim()).forEach(c => categories.add(c));
        if (book.level) levels.add(book.level);
        if (book.division) divisions.add(book.division);
        if (book.author) authors.add(book.author);
      });

      const categoryFilter = document.getElementById("categoryFilter");
      categoryFilter.innerHTML = Array.from(categories).map(c => `
        <button onclick="toggleFilter('category','${c}')" class="px-3 py-1 rounded-full border border-gray-300 text-sm hover:bg-blue-100">${c}</button>
      `).join("");

      const levelFilter = document.getElementById("levelFilter");
      levelFilter.innerHTML = Array.from(levels).map(l => `
        <button onclick="toggleFilter('level','${l}')" class="px-3 py-1 rounded-full border border-gray-300 text-sm hover:bg-blue-100">${l}</button>
      `).join("");

      const divisionFilter = document.getElementById("divisionFilter");
      divisionFilter.innerHTML = Array.from(divisions).map(d => `
        <button onclick="toggleFilter('division','${d}')" class="px-3 py-1 rounded-full border border-gray-300 text-sm hover:bg-blue-100">${d}</button>
      `).join("");

      const authorFilter = document.getElementById("authorFilter");
      authorFilter.innerHTML = Array.from(authors).map(a => `
        <button onclick="toggleFilter('author','${a}')" class="px-3 py-1 rounded-full border border-gray-300 text-sm hover:bg-blue-100">${a}</button>
      `).join("");
    }

    function toggleFilter(type, value) {
      let set;
      if (type === "category") set = selectedCategories;
      if (type === "level") set = selectedLevels;
      if (type === "division") set = selectedDivisions;
      if (type === "author") set = selectedAuthors;

      if (set.has(value)) set.delete(value);
      else set.add(value);

      loadGraph();
    }

    function renderGraph(books) {
      const svg = d3.select("#graph").html("").append("svg")
        .attr("width", "100%")
        .attr("height", "100%");

      const nodes = [];
      const links = [];

      const filteredBooks = books.filter(b => {
        const cats = b.category ? b.category.split(",").map(c => c.trim()) : [];
        return (
          (selectedCategories.size === 0 || cats.some(c => selectedCategories.has(c))) &&
          (selectedLevels.size === 0 || selectedLevels.has(b.level)) &&
          (selectedDivisions.size === 0 || selectedDivisions.has(b.division)) &&
          (selectedAuthors.size === 0 || selectedAuthors.has(b.author))
        );
      });

      filteredBooks.forEach(book => {
        const bookNode = { id: book.title, type: "book", group: "book", bookId: book.id, tooltip: book.description || "" };
        nodes.push(bookNode);

        if (book.author) {
          nodes.push({ id: book.author, type: "author", group: "author" });
          links.push({ source: book.title, target: book.author });
        }
        if (book.category) {
          book.category.split(",").map(c => c.trim()).forEach(c => {
            nodes.push({ id: c, type: "category", group: "category" });
            links.push({ source: book.title, target: c });
          });
        }
        if (book.division) {
          nodes.push({ id: book.division, type: "division", group: "division" });
          links.push({ source: book.title, target: book.division });
        }
        if (book.level) {
          nodes.push({ id: book.level, type: "level", group: "level" });
          links.push({ source: book.title, target: book.level });
        }
      });

      const uniqueNodes = Array.from(new Map(nodes.map(n => [n.id, n])).values());

      const simulation = d3.forceSimulation(uniqueNodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(100))
        .force("charge", d3.forceManyBody().strength(-300))
        .force("center", d3.forceCenter(document.getElementById("graph").clientWidth / 2, 350));

      const link = svg.append("g")
        .selectAll("line")
        .data(links)
        .enter().append("line")
        .attr("stroke", "#aaa");

      const colorMap = {
        "book": "orange",
        "author": "blue",
        "category": "green",
        "division": "purple",
        "level": "gray"
      };

      const node = svg.append("g")
        .selectAll("circle")
        .data(uniqueNodes)
        .enter().append("circle")
        .attr("r", 12)
        .attr("fill", d => colorMap[d.group] || "black")
        .call(drag(simulation));

      node.append("title").text(d => d.tooltip || d.id);

      node.on("click", (e, d) => {
        if (d.group === "book" && d.bookId) {
          window.location.href = `book-detail.html?id=${d.bookId}`;
        }
      });

      const label = svg.append("g")
        .selectAll("text")
        .data(uniqueNodes)
        .enter().append("text")
        .text(d => d.id)
        .attr("font-size", 12)
        .attr("dx", 15)
        .attr("dy", 4);

      simulation.on("tick", () => {
        link.attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);

        node.attr("cx", d => d.x).attr("cy", d => d.y);
        label.attr("x", d => d.x).attr("y", d => d.y);
      });

      function drag(simulation) {
        function dragstarted(event, d) {
          if (!event.active) simulation.alphaTarget(0.3).restart();
          d.fx = d.x; d.fy = d.y;
        }
        function dragged(event, d) {
          d.fx = event.x; d.fy = event.y;
        }
        function dragended(event, d) {
          if (!event.active) simulation.alphaTarget(0);
          d.fx = null; d.fy = null;
        }
        return d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended);
      }
    }

    loadGraph();
  </script>
</body>
</html>
