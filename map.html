<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BookMap â€” ë„ì„œ ê´€ê³„ë„</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    .tooltip {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 13px;
      max-width: 260px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 50;
      line-height: 1.4;
    }
    .tooltip img {
      width: 60px;
      height: 85px;
      object-fit: cover;
      float: left;
      margin-right: 8px;
      border-radius: 4px;
    }
    
    /* ì ‘ê·¼ì„± ê°œì„  */
    .node:focus {
      outline: 2px solid #2563eb;
      outline-offset: 2px;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <header class="bg-blue-600 text-white shadow">
    <div class="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
      <h1 class="text-xl font-bold cursor-pointer" onclick="location.href='index.html'">ğŸ“š BookMap</h1>
      <nav class="flex gap-6">
        <a href="form.html" class="hover:underline">ë„ì„œ ë“±ë¡</a>
        <a href="book.html" class="hover:underline">ë¶ë§µ ë¦¬ìŠ¤íŠ¸</a>
        <a href="map.html" class="hover:underline font-semibold">ë¶ë§µ ë³´ê¸°</a>
      </nav>
    </div>
  </header>

  <!-- ë©”ì¸ -->
  <main class="max-w-6xl mx-auto p-6">
    <h2 class="text-xl font-semibold mb-2">ğŸ“– ë„ì„œ ê´€ê³„ë„</h2>
    <p class="text-sm text-gray-600 mb-6">
      ë¶ë§µ ê´€ê³„ë„ëŠ” ë„ì„œ, ì €ì, ì£¼ì œ, ì¹´í…Œê³ ë¦¬, ë‹¨ê³„ ë“±ê³¼ ê°™ì€ ê´€ê³„ì— ë”°ë¼ ì—°ê²°ë˜ëŠ” ê²ƒì„ ë³´ì—¬ì¤ë‹ˆë‹¤.<br>
      ë„ì„œëª…ì´ë‚˜ ì €ì ì´ë¦„ì— <strong>ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ê°„ë‹¨í•œ ì„¤ëª…</strong>ì„ ë³¼ ìˆ˜ ìˆìœ¼ë©°, í´ë¦­í•˜ë©´ í•´ë‹¹ ë„ì„œ ìƒì„¸í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.<br>
      <strong>ë§ˆìš°ìŠ¤ íœ ë¡œ í™•ëŒ€/ì¶•ì†Œ</strong>, <strong>ë“œë˜ê·¸ë¡œ ì´ë™</strong>ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
    </p>

    <!-- í•„í„° ì˜ì—­ -->
    <div id="filters" class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-6">
      <div>
        <h3 class="text-sm font-semibold mb-2">ì¹´í…Œê³ ë¦¬</h3>
        <div id="filter-category" class="flex flex-wrap gap-2"></div>
      </div>
      <div>
        <h3 class="text-sm font-semibold mb-2">ë‹¨ê³„</h3>
        <div id="filter-level" class="flex flex-wrap gap-2"></div>
      </div>
      <div>
        <h3 class="text-sm font-semibold mb-2">ë„ì„œêµ¬ë¶„</h3>
        <div id="filter-division" class="flex flex-wrap gap-2"></div>
      </div>
      <div>
        <h3 class="text-sm font-semibold mb-2">ì €ì</h3>
        <div id="filter-author" class="flex flex-wrap gap-2"></div>
      </div>
      <div>
        <h3 class="text-sm font-semibold mb-2">ì£¼ì œ</h3>
        <div id="filter-subject" class="flex flex-wrap gap-2"></div>
      </div>
    </div>

    <!-- ë²”ë¡€ -->
    <div class="mb-4 flex gap-4 text-sm">
      <span class="flex items-center gap-1">
        <span class="w-3 h-3 rounded-full" style="background-color: #60a5fa;"></span> ë„ì„œ
      </span>
      <span class="flex items-center gap-1">
        <span class="w-3 h-3 rounded-full" style="background-color: #4ade80;"></span> ì €ì
      </span>
      <span class="flex items-center gap-1">
        <span class="w-3 h-3 rounded-full" style="background-color: #fbbf24;"></span> ì¹´í…Œê³ ë¦¬
      </span>
      <span class="flex items-center gap-1">
        <span class="w-3 h-3 rounded-full" style="background-color: #a78bfa;"></span> ì£¼ì œ
      </span>
      <span class="flex items-center gap-1">
        <span class="w-3 h-3 rounded-full" style="background-color: #f87171;"></span> ë„ì„œêµ¬ë¶„
      </span>
    </div>

    <!-- ë¡œë”© ì¸ë””ì¼€ì´í„° -->
    <div id="loading" class="flex items-center justify-center py-10 text-blue-600 text-lg font-semibold">
      <svg class="animate-spin h-6 w-6 mr-2 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...
    </div>
    
    <!-- ê·¸ë˜í”„ -->
    <div class="bg-white rounded-xl shadow p-4">
      <svg id="graph" width="100%" height="600" style="display: none;"></svg>
    </div>
  </main>

  <!-- Tooltip -->
  <div id="tooltip" class="tooltip"></div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbywJOW4dOlmDrzood3ka_jizri4K7sFqTJDPG8ibnmDrxXZgFWrFnjMEv38C5pCtjp_/exec";
    let books = [];
    let activeFilters = { category: [], level: [], division: [], author: [], subject: [] };

    // ìƒ‰ìƒ ë§µ - ë²”ë¡€ì™€ ì¼ì¹˜í•˜ë„ë¡ ìˆ˜ì •
    const colorMap = { 
      "ë„ì„œ": "#60a5fa",      // blue-400
      "ì €ì": "#4ade80",      // green-400  
      "ì¹´í…Œê³ ë¦¬": "#fbbf24",  // yellow-400
      "ì£¼ì œ": "#a78bfa",      // purple-400
      "ë„ì„œêµ¬ë¶„": "#f87171"   // red-400
    };

    async function loadBooks() {
      const loadingEl = document.getElementById("loading");
      const graphEl = document.getElementById("graph");
      let dataLoaded = false;

      try {
        loadingEl.style.display = "flex";
        
        const res = await fetch(API_URL);
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        
        books = await res.json();
        if (!Array.isArray(books)) {
          throw new Error('Invalid data format');
        }

        renderFilters();
        renderGraph();
        dataLoaded = true;

      } catch (err) {
        console.error('Data loading failed:', err);
        loadingEl.innerHTML = `
          <div class="text-red-600 text-center">
            <svg class="h-8 w-8 mx-auto mb-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
            </svg>
            <p>ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨ ğŸ˜¢</p>
            <button onclick="location.reload()" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
              ë‹¤ì‹œ ì‹œë„
            </button>
          </div>
        `;
      } finally {
        if (dataLoaded) {
          loadingEl.style.display = "none";
          graphEl.style.display = "block";
        }
      }
    }

    function renderFilters() {
      const categories = new Set(), levels = new Set(), divisions = new Set(), authors = new Set(), subjects = new Set();

      books.forEach(b => {
        // ì•ˆì „í•œ ë¬¸ìì—´ ì²˜ë¦¬
        if (b.category) {
          b.category.toString().split(",").forEach(v => {
            const trimmed = v.trim();
            if (trimmed) categories.add(trimmed);
          });
        }
        if (b.level) levels.add(b.level.toString().trim());
        if (b.division) divisions.add(b.division.toString().trim());
        if (b.author) authors.add(b.author.toString().trim());
        
        if (b.subject) {
          if (Array.isArray(b.subject)) {
            b.subject.forEach(s => {
              const trimmed = s.toString().trim();
              if (trimmed) subjects.add(trimmed);
            });
          } else {
            b.subject.toString().split(",").forEach(s => {
              const trimmed = s.trim();
              if (trimmed) subjects.add(trimmed);
            });
          }
        }
      });

      makeFilterButtons("filter-category", [...categories], "category");
      makeFilterButtons("filter-level", [...levels], "level");
      makeFilterButtons("filter-division", [...divisions], "division");
      makeFilterButtons("filter-author", [...authors], "author");
      makeFilterButtons("filter-subject", [...subjects], "subject");
    }

    function makeFilterButtons(containerId, items, type) {
      const container = document.getElementById(containerId);
      if (!container) return;
      
      container.innerHTML = "";
      items.forEach(item => {
        const btn = document.createElement("button");
        btn.textContent = item;
        btn.className = "px-3 py-1 rounded-full border text-sm bg-gray-100 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-500";
        btn.setAttribute('aria-pressed', 'false');
        btn.onclick = () => toggleFilter(type, item, btn);
        container.appendChild(btn);
      });
    }

    function toggleFilter(type, value, btn) {
      const isActive = activeFilters[type].includes(value);
      
      if (isActive) {
        activeFilters[type] = activeFilters[type].filter(v => v !== value);
        btn.classList.remove("bg-blue-500", "text-white");
        btn.classList.add("bg-gray-100");
        btn.setAttribute('aria-pressed', 'false');
      } else {
        activeFilters[type].push(value);
        btn.classList.add("bg-blue-500", "text-white");
        btn.classList.remove("bg-gray-100");
        btn.setAttribute('aria-pressed', 'true');
      }
      renderGraph();
    }

    function renderGraph() {
      const svg = d3.select("#graph");
      svg.selectAll("*").remove();

      const width = svg.node().clientWidth;
      const height = 600;

      const g = svg.append("g");

      // ì¤Œ/íŒ¬ ê¸°ëŠ¥
      const zoom = d3.zoom()
        .scaleExtent([0.3, 3])
        .on("zoom", (event) => {
          g.attr("transform", event.transform);
        });

      svg.call(zoom);

      const nodes = [], links = [];
      const tooltip = document.getElementById("tooltip");
      const nodeMap = new Map(); // ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•œ ë§µ

      // í•„í„°ë§ëœ ë„ì„œë“¤ë§Œ ì²˜ë¦¬
      const filteredBooks = books.filter(book => {
        return (
          (activeFilters.category.length === 0 || activeFilters.category.some(v => book.category?.includes(v))) &&
          (activeFilters.level.length === 0 || activeFilters.level.includes(book.level)) &&
          (activeFilters.division.length === 0 || activeFilters.division.includes(book.division)) &&
          (activeFilters.author.length === 0 || activeFilters.author.includes(book.author)) &&
          (activeFilters.subject.length === 0 || activeFilters.subject.some(v => {
            if (Array.isArray(book.subject)) {
              return book.subject.some(s => s.includes(v));
            } else {
              return book.subject?.includes(v);
            }
          }))
        );
      });

      // ë…¸ë“œ ë° ë§í¬ ìƒì„±
      filteredBooks.forEach(book => {
        // ë„ì„œ ë…¸ë“œ
        const bookNode = {
          id: book.id,
          name: book.title,
          type: "ë„ì„œ",
          description: book.description,
          image: book.image
        };
        nodeMap.set(book.id, bookNode);

        // ì €ì ë…¸ë“œ ë° ë§í¬
        if (book.author) {
          const authorId = `author-${book.author}`;
          if (!nodeMap.has(authorId)) {
            nodeMap.set(authorId, {
              id: authorId,
              name: book.author,
              type: "ì €ì"
            });
          }
          links.push({ source: book.id, target: authorId });
        }

        // ì¹´í…Œê³ ë¦¬ ë…¸ë“œ ë° ë§í¬
        if (book.category) {
          book.category.toString().split(",").forEach(c => {
            const trimmed = c.trim();
            if (trimmed) {
              const catId = `cat-${trimmed}`;
              if (!nodeMap.has(catId)) {
                nodeMap.set(catId, {
                  id: catId,
                  name: trimmed,
                  type: "ì¹´í…Œê³ ë¦¬"
                });
              }
              links.push({ source: book.id, target: catId });
            }
          });
        }

        // ë„ì„œêµ¬ë¶„ ë…¸ë“œ ë° ë§í¬
        if (book.division) {
          const divId = `div-${book.division}`;
          if (!nodeMap.has(divId)) {
            nodeMap.set(divId, {
              id: divId,
              name: book.division,
              type: "ë„ì„œêµ¬ë¶„"
            });
          }
          links.push({ source: book.id, target: divId });
        }

        // ì£¼ì œ ë…¸ë“œ ë° ë§í¬
        if (book.subject) {
          const subjects = Array.isArray(book.subject) ? book.subject : book.subject.toString().split(",");
          subjects.forEach(s => {
            const trimmed = s.toString().trim();
            if (trimmed) {
              const subId = `sub-${trimmed}`;
              if (!nodeMap.has(subId)) {
                nodeMap.set(subId, {
                  id: subId,
                  name: trimmed,
                  type: "ì£¼ì œ"
                });
              }
              links.push({ source: book.id, target: subId });
            }
          });
        }
      });

      const uniqueNodes = Array.from(nodeMap.values());

      // ë¹ˆ ê·¸ë˜í”„ ì²˜ë¦¬
      if (uniqueNodes.length === 0) {
        g.append("text")
          .attr("x", width / 2)
          .attr("y", height / 2)
          .attr("text-anchor", "middle")
          .attr("font-size", "16px")
          .attr("fill", "#6b7280")
          .text("ì„ íƒí•œ í•„í„°ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      // ì‹œë®¬ë ˆì´ì…˜ ì„¤ì •
      const simulation = d3.forceSimulation(uniqueNodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(120))
        .force("charge", d3.forceManyBody().strength(-300))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .force("collision", d3.forceCollide().radius(15));

      // ë§í¬ ê·¸ë¦¬ê¸°
      const link = g.append("g")
        .selectAll("line")
        .data(links)
        .enter().append("line")
        .attr("stroke", "#aaa")
        .attr("stroke-width", 1);

      // ë…¸ë“œ ê·¸ë¦¬ê¸°
      const node = g.append("g")
        .selectAll("circle")
        .data(uniqueNodes)
        .enter().append("circle")
        .attr("r", d => d.type === "ë„ì„œ" ? 15 : 12)
        .attr("fill", d => colorMap[d.type] || "#6b7280")
        .attr("stroke", "#fff")
        .attr("stroke-width", 2)
        .attr("class", "node")
        .attr("tabindex", "0")
        .style("cursor", d => d.type === "ë„ì„œ" ? "pointer" : "default")
        .call(drag(simulation));

      // ë¼ë²¨ ê·¸ë¦¬ê¸°
      const label = g.append("g")
        .selectAll("text")
        .data(uniqueNodes)
        .enter().append("text")
        .text(d => d.name.length > 15 ? d.name.substring(0, 15) + "..." : d.name)
        .attr("font-size", "10px")
        .attr("text-anchor", "middle")
        .attr("dy", -20)
        .attr("fill", "#374151")
        .style("pointer-events", "none");

      // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
      node.on("mouseover", (event, d) => {
        if (d.type === "ë„ì„œ") {
          tooltip.innerHTML = `
            <img src="${d.image || ""}" alt="í‘œì§€" onerror="this.style.display='none'">
            <div><strong>${d.name}</strong><br>${d.description || "ì„¤ëª… ì—†ìŒ"}</div>
          `;
        } else {
          tooltip.innerHTML = `<strong>${d.type}</strong><br>${d.name}`;
        }
        tooltip.style.opacity = 1;
      })
      .on("mousemove", (event) => {
        tooltip.style.left = (event.pageX + 12) + "px";
        tooltip.style.top = (event.pageY - 28) + "px";
      })
      .on("mouseout", () => {
        tooltip.style.opacity = 0;
      })
      .on("click", (event, d) => {
        if (d.type === "ë„ì„œ") {
          window.location.href = `book-detail.html?id=${d.id}`;
        }
      });

      // ì‹œë®¬ë ˆì´ì…˜ tick ì´ë²¤íŠ¸
      simulation.on("tick", () => {
        link
          .attr("x1", d => d.source.x)
          .attr("y1", d => d.source.y)
          .attr("x2", d => d.target.x)
          .attr("y2", d => d.target.y);

        node
          .attr("cx", d => d.x)
          .attr("cy", d => d.y);

        label
          .attr("x", d => d.x)
          .attr("y", d => d.y);
      });
    }

    function drag(simulation) {
      return d3.drag()
        .on("start", (event, d) => {
          if (!event.active) simulation.alphaTarget(0.3).restart();
          d.fx = d.x;
          d.fy = d.y;
        })
        .on("drag", (event, d) => {
          d.fx = event.x;
          d.fy = event.y;
        })
        .on("end", (event, d) => {
          if (!event.active) simulation.alphaTarget(0);
          d.fx = null;
          d.fy = null;
        });
    }

    // ì°½ í¬ê¸° ë³€ê²½ ì‹œ ê·¸ë˜í”„ ì¬ì¡°ì •
    window.addEventListener('resize', () => {
      if (books.length > 0) {
        renderGraph();
      }
    });

    // ì´ˆê¸° ë¡œë“œ
    loadBooks();
  </script>
</body>
</html>
