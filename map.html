<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BookMap — 관계도</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- 상단 네비게이션 -->
  <header class="bg-blue-600 text-white shadow">
    <div class="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
      <h1 class="text-xl font-bold">📚 BookMap</h1>
      <nav class="flex gap-6 text-sm">
        <a href="index.html" class="hover:underline">홈</a>
        <a href="form.html" class="hover:underline">도서 등록</a>
        <a href="book.html" class="hover:underline">북맵 리스트</a>
        <a href="map.html" class="hover:underline">관계도</a>
      </nav>
    </div>
  </header>

  <!-- 메인 -->
  <main class="max-w-6xl mx-auto px-6 py-10">
    <h2 class="text-2xl font-bold mb-6">📖 도서 관계도</h2>

    <!-- 필터 -->
    <section class="bg-white p-6 rounded-xl shadow mb-6">
      <h3 class="font-semibold mb-4">필터</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- 카테고리 -->
        <div>
          <h4 class="text-sm font-medium mb-2">카테고리</h4>
          <div id="categoryFilter" class="flex flex-wrap gap-2"></div>
        </div>
        <!-- 단계 -->
        <div>
          <h4 class="text-sm font-medium mb-2">단계</h4>
          <div id="levelFilter" class="flex flex-wrap gap-2"></div>
        </div>
        <!-- 도서구분 -->
        <div>
          <h4 class="text-sm font-medium mb-2">도서구분</h4>
          <div id="divisionFilter" class="flex flex-wrap gap-2"></div>
        </div>
      </div>

      <!-- 노드 색상 범례 -->
      <div class="mt-6 flex flex-wrap gap-6 text-sm text-gray-700">
        <div class="flex items-center gap-2">
          <span class="w-4 h-4 rounded-full inline-block" style="background-color: blue;"></span>
          <span>카테고리 / 단계 노드</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="w-4 h-4 rounded-full inline-block" style="background-color: red;"></span>
          <span>도서 노드 — 국내서</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="w-4 h-4 rounded-full inline-block" style="background-color: purple;"></span>
          <span>도서 노드 — 원서</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="w-4 h-4 rounded-full inline-block" style="background-color: orange;"></span>
          <span>도서 노드 — 번역서</span>
        </div>
      </div>
    </section>

    <!-- 관계도 차트 -->
    <section class="bg-white p-6 rounded-xl shadow">
      <div id="chart" class="w-full h-[600px]"></div>
    </section>
  </main>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbywJOW4dOlmDrzood3ka_jizri4K7sFqTJDPG8ibnmDrxXZgFWrFnjMEv38C5pCtjp_/exec";

    let allBooks = [];
    let selectedCategories = new Set();
    let selectedLevels = new Set();
    let selectedDivisions = new Set();

    async function loadBooks() {
      const res = await fetch(API_URL);
      allBooks = await res.json();

      renderFilters();
      updateGraph();
    }

    /* ---------- 필터 렌더링 ---------- */
    function renderFilters() {
      const categories = new Set();
      const levels = new Set();
      const divisions = new Set(["국내서","원서","번역서"]); // 항상 고정 표시

      allBooks.forEach(book => {
        let cats = [];
        if (Array.isArray(book.category)) cats = book.category;
        else if (typeof book.category === "string") cats = book.category.split(",").map(c => c.trim());
        cats.forEach(c => categories.add(c));

        if (book.level) levels.add(book.level);
        if (book.division) divisions.add(book.division);
      });

      document.getElementById("categoryFilter").innerHTML =
        Array.from(categories).map(cat => `
          <button onclick="toggleFilter('category','${cat}')"
            class="px-3 py-1 rounded-full border border-gray-300 text-sm hover:bg-blue-100">
            ${cat}
          </button>`).join("");

      document.getElementById("levelFilter").innerHTML =
        Array.from(levels).map(level => `
          <button onclick="toggleFilter('level','${level}')"
            class="px-3 py-1 rounded-full border border-gray-300 text-sm hover:bg-blue-100">
            ${level}
          </button>`).join("");

      document.getElementById("divisionFilter").innerHTML =
        Array.from(divisions).map(div => `
          <button onclick="toggleFilter('division','${div}')"
            class="px-3 py-1 rounded-full border border-gray-300 text-sm hover:bg-blue-100">
            ${div}
          </button>`).join("");
    }

    /* ---------- 필터 상태 관리 ---------- */
    function toggleFilter(type, value) {
      let set;
      if (type === "category") set = selectedCategories;
      if (type === "level") set = selectedLevels;
      if (type === "division") set = selectedDivisions;

      if (set.has(value)) set.delete(value);
      else set.add(value);

      updateGraph();
    }

    function getFilteredBooks() {
      return allBooks.filter(book => {
        let cats = Array.isArray(book.category)
          ? book.category
          : (typeof book.category === "string" ? book.category.split(",").map(c => c.trim()) : []);

        const categoryMatch = selectedCategories.size === 0 || cats.some(c => selectedCategories.has(c));
        const levelMatch = selectedLevels.size === 0 || selectedLevels.has(book.level);
        const divisionMatch = selectedDivisions.size === 0 || selectedDivisions.has(book.division);

        return categoryMatch && levelMatch && divisionMatch;
      });
    }

    /* ---------- 관계도 생성 ---------- */
    function buildHierarchy(books) {
      const root = { name: "도서", children: [] };
      const catMap = {};

      books.forEach(b => {
        let cats = Array.isArray(b.category) ? b.category : b.category.split(",").map(c => c.trim());

        cats.forEach(cat => {
          if (!catMap[cat]) {
            catMap[cat] = { name: cat, children: [] };
            root.children.push(catMap[cat]);
          }

          let levelNode = catMap[cat].children.find(c => c.name === b.level);
          if (!levelNode) {
            levelNode = { name: b.level, children: [] };
            catMap[cat].children.push(levelNode);
          }

          levelNode.children.push({
            name: b.title,
            id: b.id,
            author: b.author,
            division: b.division || "국내서" // 기본값
          });
        });
      });

      return root;
    }

    function updateGraph() {
      const filteredBooks = getFilteredBooks();
      const rootData = buildHierarchy(filteredBooks);
      d3.select("#chart").selectAll("*").remove();
      drawChart(rootData);
    }

    /* ---------- D3.js 시각화 ---------- */
    function drawChart(data) {
      const width = document.getElementById("chart").clientWidth;
      const height = document.getElementById("chart").clientHeight;

      const svg = d3.select("#chart")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

      const g = svg.append("g").attr("transform", "translate(40,40)");

      const root = d3.hierarchy(data);
      const treeLayout = d3.tree().size([height - 80, width - 160]);
      treeLayout(root);

      g.selectAll(".link")
        .data(root.links())
        .enter()
        .append("line")
        .attr("class", "link")
        .attr("stroke", "#ccc")
        .attr("x1", d => d.source.y)
        .attr("y1", d => d.source.x)
        .attr("x2", d => d.target.y)
        .attr("y2", d => d.target.x);

      const node = g.selectAll(".node")
        .data(root.descendants())
        .enter()
        .append("g")
        .attr("class", "node")
        .attr("transform", d => `translate(${d.y},${d.x})`);

      node.append("circle")
        .attr("r", 5)
        .attr("fill", d => {
          if (d.children) return "blue"; // 카테고리/단계 노드
          if (d.data.division === "원서") return "purple";
          if (d.data.division === "번역서") return "orange";
          return "red"; // 국내서
        })
        .on("click", (e, d) => {
          if (!d.children && d.data.id) {
            window.location.href = `book-detail.html?id=${d.data.id}`;
          }
        });

      node.append("text")
        .attr("dx", 10)
        .attr("dy", 4)
        .text(d => d.data.name);
    }

    loadBooks();
  </script>
</body>
</html>
