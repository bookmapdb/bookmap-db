<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BookMap — 도서 관계도</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- 상단 네비게이션 -->
  <header class="bg-blue-600 text-white shadow">
    <div class="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
      <h1 class="text-xl font-bold">📚 BookMap</h1>
      <nav class="flex gap-6">
        <a href="index.html" class="hover:underline">홈</a>
        <a href="register.html" class="hover:underline">도서 등록</a>
        <a href="book.html" class="hover:underline">북맵 리스트</a>
        <a href="map.html" class="font-bold underline">북맵 보기</a>
      </nav>
    </div>
  </header>

  <!-- 컨테이너 -->
  <main class="max-w-6xl mx-auto px-6 py-10">
    <h2 class="text-2xl font-bold mb-4">📖 도서 관계도</h2>
    <p class="text-gray-700 mb-6">
      북맵 관계도는 도서, 저자, 주제, 단계 등과 같은 관계에 따라 연결되는 것을 보여줍니다. 
      도서명이나 저자 이름에 마우스를 올리면 간단한 설명을 볼 수 있으며, 
      <span class="font-semibold">클릭하시면 해당 도서 상세페이지로 이동합니다.</span>
    </p>

    <!-- 필터 -->
    <section id="filters" class="bg-white p-4 rounded shadow mb-6">
      <h3 class="text-lg font-semibold mb-3">필터</h3>
      <div class="flex flex-wrap gap-6">
        <div>
          <p class="font-medium mb-2">카테고리</p>
          <div id="filter-category" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <p class="font-medium mb-2">단계</p>
          <div id="filter-level" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <p class="font-medium mb-2">도서구분</p>
          <div id="filter-division" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <p class="font-medium mb-2">저자</p>
          <div id="filter-author" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <p class="font-medium mb-2">주제</p>
          <div id="filter-subject" class="flex flex-wrap gap-2"></div>
        </div>
      </div>
    </section>

    <!-- 노드 색상 안내 -->
    <section class="bg-gray-100 p-3 rounded mb-6 text-sm text-gray-700">
      <div class="flex flex-wrap gap-6 items-center">
        <span class="flex items-center gap-1">
          <span class="w-3 h-3 rounded-full inline-block" style="background:black;"></span> 큰 주제 (검은색)
        </span>
        <span class="flex items-center gap-1">
          <span class="w-3 h-3 rounded-full inline-block" style="background:purple;"></span> 세부 주제 (보라색)
        </span>
        <span class="flex items-center gap-1">
          <span class="w-3 h-3 rounded-full inline-block" style="background:blue;"></span> 저자 (파란색)
        </span>
        <span class="flex items-center gap-1">
          <span class="w-3 h-3 rounded-full inline-block" style="background:orange;"></span> 카테고리 (주황색)
        </span>
        <span class="flex items-center gap-1">
          <span class="w-3 h-3 rounded-full inline-block" style="background:green;"></span> 도서구분 (초록색)
        </span>
        <span class="flex items-center gap-1">
          <span class="w-3 h-3 rounded-full inline-block" style="background:gray;"></span> 도서 (회색)
        </span>
      </div>
    </section>

    <!-- 로딩 메시지 -->
    <div id="loading" class="text-center text-gray-600 my-6">⏳ 북맵 관계도를 로딩중입니다. 잠시만 기다려주세요. 감사합니다.</div>

    <!-- 그래프 -->
    <section class="bg-white p-4 rounded shadow">
      <svg id="graph" width="100%" height="600"></svg>
    </section>
  </main>

  <script>
    const colorScale = {
      theme: "black",
      subject: "purple",
      author: "blue",
      category: "orange",
      division: "green",
      book: "gray"
    };

    // ✅ 필터 버튼 생성 함수
    function createFilterButtons(containerId, items) {
      const container = document.getElementById(containerId);
      items.forEach(item => {
        const btn = document.createElement("button");
        btn.textContent = item;
        btn.className =
          "px-3 py-1 border rounded-full text-sm cursor-pointer transition " +
          "bg-gray-100 hover:bg-blue-100";
        btn.addEventListener("click", () => {
          btn.classList.toggle("bg-blue-500");
          btn.classList.toggle("text-white");
          btn.classList.toggle("border-blue-500");
          applyFilters();
        });
        container.appendChild(btn);
      });
    }

    // ✅ 데이터 로드
    fetch("books.json")
      .then(res => res.json())
      .then(data => {
        document.getElementById("loading").style.display = "none";
        initGraph(data);
        initFilters(data);
      })
      .catch(err => {
        console.error("데이터 로드 오류:", err);
        document.getElementById("loading").textContent =
          "❌ 데이터를 불러오는 중 오류가 발생했습니다.";
      });

    function initFilters(data) {
      const categories = new Set();
      const levels = new Set();
      const divisions = new Set();
      const authors = new Set();
      const subjects = new Set();

      data.forEach(b => {
        b.category?.split(",").map(c => categories.add(c.trim()));
        if (b.level) levels.add(b.level.trim());
        if (b.division) divisions.add(b.division.trim());
        if (b.author) authors.add(b.author.trim());
        if (b.subject) subjects.add(b.subject.trim());
      });

      createFilterButtons("filter-category", [...categories]);
      createFilterButtons("filter-level", [...levels]);
      createFilterButtons("filter-division", [...divisions]);
      createFilterButtons("filter-author", [...authors]);
      createFilterButtons("filter-subject", [...subjects]);
    }

    // ✅ 필터 적용
    function applyFilters() {
      console.log("필터링 동작 (그래프 업데이트 필요)");
      // 여기서 선택된 필터 값에 맞게 그래프를 다시 그리는 로직 추가 예정
    }

    // ✅ D3.js 그래프
    function initGraph(data) {
      const svg = d3.select("#graph");
      const width = +svg.attr("width").replace("%", "") || 800;
      const height = +svg.attr("height") || 600;

      const nodes = [];
      const links = [];

      data.forEach(b => {
        nodes.push({ id: b.title, type: "book", info: b });
        if (b.author)
          nodes.push({ id: b.author, type: "author" });
        if (b.category)
          b.category.split(",").forEach(c =>
            nodes.push({ id: c.trim(), type: "category" })
          );
        if (b.division)
          nodes.push({ id: b.division, type: "division" });
        if (b.level)
          nodes.push({ id: b.level, type: "subject" });
      });

      const uniqueNodes = Array.from(new Map(nodes.map(n => [n.id, n])).values());

      data.forEach(b => {
        if (b.author) links.push({ source: b.title, target: b.author });
        if (b.category)
          b.category.split(",").forEach(c =>
            links.push({ source: b.title, target: c.trim() })
          );
        if (b.division) links.push({ source: b.title, target: b.division });
        if (b.level) links.push({ source: b.title, target: b.level });
      });

      const simulation = d3
        .forceSimulation(uniqueNodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(120))
        .force("charge", d3.forceManyBody().strength(-300))
        .force("center", d3.forceCenter(width / 2, height / 2));

      const link = svg
        .append("g")
        .attr("stroke", "#ccc")
        .selectAll("line")
        .data(links)
        .join("line")
        .attr("stroke-width", 1.5);

      const node = svg
        .append("g")
        .attr("stroke", "#fff")
        .attr("stroke-width", 1.5)
        .selectAll("circle")
        .data(uniqueNodes)
        .join("circle")
        .attr("r", 10)
        .attr("fill", d => colorScale[d.type] || "gray")
        .call(drag(simulation));

      node.append("title").text(d => d.id);

      simulation.on("tick", () => {
        link
          .attr("x1", d => d.source.x)
          .attr("y1", d => d.source.y)
          .attr("x2", d => d.target.x)
          .attr("y2", d => d.target.y);

        node.attr("cx", d => d.x).attr("cy", d => d.y);
      });

      function drag(simulation) {
        function dragstarted(event, d) {
          if (!event.active) simulation.alphaTarget(0.3).restart();
          d.fx = d.x;
          d.fy = d.y;
        }

        function dragged(event, d) {
          d.fx = event.x;
          d.fy = event.y;
        }

        function dragended(event, d) {
          if (!event.active) simulation.alphaTarget(0);
          d.fx = null;
          d.fy = null;
        }

        return d3.drag()
          .on("start", dragstarted)
          .on("drag", dragged)
          .on("end", dragended);
      }
    }
  </script>
</body>
</html>
