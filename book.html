<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BookMap — 북맵 리스트</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- 상단 네비게이션 -->
  <header class="bg-blue-600 text-white shadow">
    <div class="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
      <h1 class="text-xl font-bold">📚 BookMap</h1>
      <nav class="flex gap-6 text-sm">
        <a href="index.html" class="hover:underline">홈</a>
        <a href="form.html" class="hover:underline">도서 등록</a>
        <a href="book.html" class="hover:underline font-bold">북맵 리스트</a>
        <a href="map.html" class="hover:underline">북맵 보기</a>
      </nav>
    </div>
  </header>

  <!-- 메인 -->
  <main class="max-w-6xl mx-auto px-6 py-10">
    <h2 class="text-2xl font-bold mb-6">📖 북맵 리스트</h2>

    <!-- 필터 -->
    <section class="bg-white p-6 rounded-xl shadow mb-8">
      <h3 class="font-semibold mb-4">필터</h3>

      <!-- 카테고리 -->
      <div class="mb-4">
        <h4 class="text-sm font-medium mb-2">카테고리</h4>
        <div id="categoryFilter" class="flex flex-wrap gap-2"></div>
      </div>

      <!-- 단계 -->
      <div class="mb-4">
        <h4 class="text-sm font-medium mb-2">단계</h4>
        <div id="levelFilter" class="flex flex-wrap gap-2"></div>
      </div>

      <!-- 도서구분 -->
      <div>
        <h4 class="text-sm font-medium mb-2">도서구분</h4>
        <div id="divisionFilter" class="flex flex-wrap gap-2"></div>
      </div>
    </section>

    <!-- 도서 리스트 -->
    <section id="bookList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></section>
  </main>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbywJOW4dOlmDrzood3ka_jizri4K7sFqTJDPG8ibnmDrxXZgFWrFnjMEv38C5pCtjp_/exec";
    let allBooks = [];
    let activeFilters = { category: [], level: [], division: [] };

    async function loadBooks() {
      const res = await fetch(API_URL);
      allBooks = await res.json();

      renderFilters(allBooks);
      renderBooks(allBooks);
    }

    function renderFilters(books) {
      const categories = new Set();
      const levels = new Set();
      const divisions = new Set();

      books.forEach(b => {
        b.category?.split(",").map(c => categories.add(c.trim()));
        if (b.level) levels.add(b.level.trim());
        if (b.division) divisions.add(b.division.trim());
      });

      renderFilterButtons("categoryFilter", "category", [...categories]);
      renderFilterButtons("levelFilter", "level", [...levels]);
      renderFilterButtons("divisionFilter", "division", [...divisions]);
    }

    function renderFilterButtons(containerId, type, items) {
      document.getElementById(containerId).innerHTML = items.map(item => `
        <button 
          id="${type}-${item}"
          class="px-3 py-1 border border-gray-300 rounded-full text-sm transition"
          onclick="toggleFilter('${type}','${item}')"
        >${item}</button>
      `).join("");
    }

    function toggleFilter(type, value) {
      const idx = activeFilters[type].indexOf(value);
      const button = document.getElementById(`${type}-${value}`);

      if (idx > -1) {
        activeFilters[type].splice(idx, 1);
        button.classList.remove("bg-blue-500", "text-white", "border-blue-500");
        button.classList.add("border-gray-300");
      } else {
        activeFilters[type].push(value);
        button.classList.remove("border-gray-300");
        button.classList.add("bg-blue-500", "text-white", "border-blue-500");
      }
      renderBooks(allBooks);
    }

    function renderBooks(books) {
      const filtered = books.filter(b => {
        const matchCategory = activeFilters.category.length === 0 || activeFilters.category.some(f => b.category?.includes(f));
        const matchLevel = activeFilters.level.length === 0 || activeFilters.level.includes(b.level);
        const matchDivision = activeFilters.division.length === 0 || activeFilters.division.includes(b.division);
        return matchCategory && matchLevel && matchDivision;
      });

      document.getElementById("bookList").innerHTML = filtered.map(b => `
        <div class="bg-white rounded-xl shadow hover:shadow-md transition p-4 flex flex-col">
          <img src="${b.image}" alt="${b.title}" class="h-48 w-full object-cover rounded-md mb-4">
          <h3 class="font-bold text-lg mb-1">${b.title}</h3>
          <p class="text-sm text-gray-600 mb-2">${b.author} | ${b.publisher}</p>
          <p class="text-sm text-gray-500 mb-4">${b.reason || ""}</p>
          <a href="book-detail.html?id=${b.id}" class="mt-auto text-blue-600 hover:underline">상세보기 →</a>
        </div>
      `).join("");
    }

    loadBooks();
  </script>
</body>
</html>
